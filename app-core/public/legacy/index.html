<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FOT legacy</title>
  <style>html,body{margin:0;height:100%;background:#09090b}</style>
</head>
<body>
  <div id="fot-app"></div>
<style>
  #fot-app{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    --bg:#09090b;
    --surface:#09090b;
    --surface-2:rgba(9,9,11,.35);
    --surface-3:rgba(9,9,11,.45);
    --card-bg:rgba(9,9,11,.65);
    --border:#27272a;
    --text:#f4f4f5;
    --text-strong:#fafafa;
    --text-soft:#e4e4e7;
    --text-muted:#a1a1aa;
    --text-mid:#d4d4d8;
    --pill-on-bg:#fafafa;
    --pill-on-text:#09090b;
    --pill-off-bg:rgba(9,9,11,.35);
    --btn-primary-bg:#fafafa;
    --btn-primary-text:#09090b;
    --backdrop:rgba(0,0,0,.62);
    --shadow-card:0 18px 40px rgba(0,0,0,.35);
    --shadow-dialog:0 30px 80px rgba(0,0,0,.7);
    --focus-ring:rgba(113,113,122,.7);
    --cell-bg:rgba(9,9,11,.25);
    --cell-hover:rgba(9,9,11,.45);
    --thead-bg:rgba(9,9,11,.6);
  }
  #fot-app .theme-light{
    --bg:#f5f7fb;
    --surface:#ffffff;
    --surface-2:#f8fafc;
    --surface-3:#f1f5f9;
    --card-bg:#ffffff;
    --border:#d4d8e1;
    --text:#1f2937;
    --text-strong:#111827;
    --text-soft:#374151;
    --text-muted:#6b7280;
    --text-mid:#4b5563;
    --pill-on-bg:#111827;
    --pill-on-text:#ffffff;
    --pill-off-bg:#f3f4f6;
    --btn-primary-bg:#111827;
    --btn-primary-text:#ffffff;
    --backdrop:rgba(15,23,42,.35);
    --shadow-card:0 16px 30px rgba(15,23,42,.08);
    --shadow-dialog:0 28px 60px rgba(15,23,42,.16);
    --focus-ring:rgba(59,130,246,.35);
    --cell-bg:#f8fafc;
    --cell-hover:rgba(17,24,39,.08);
    --thead-bg:#f3f4f6;
  }
  #fot-app *{box-sizing:border-box}
  .bg{min-height:100vh;background:var(--bg);color:var(--text)}
  .wrap{max-width:1500px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:16px}
  @media (min-width:1024px){.grid{grid-template-columns:340px 1fr}}
  .card{border:1px solid var(--border);background:var(--card-bg);border-radius:24px;box-shadow:var(--shadow-card);overflow:hidden}
  .card-h{padding:18px 18px 10px;display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .card-b{padding:0 18px 18px}
  .t{font-size:13px;font-weight:600;color:var(--text-strong);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .st{font-size:12px;color:var(--text-muted);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chip{border:1px solid var(--border);background:var(--surface-3);border-radius:16px;padding:8px 10px;font-size:12px;color:var(--text-muted)}
  .row{display:grid;gap:12px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .pill{border-radius:999px;padding:8px 14px;font-size:13px;font-weight:600;cursor:pointer;user-select:none}
  .pill.on{background:var(--pill-on-bg);color:var(--pill-on-text)}
  .pill.off{background:var(--pill-off-bg);color:var(--text-soft);border:1px solid var(--border)}
  .btn{border-radius:16px;padding:12px 14px;font-size:13px;font-weight:700;cursor:pointer;border:1px solid var(--border)}
  .btn.primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);border-color:var(--btn-primary-bg)}
  .btn.ghost{background:var(--surface-2);color:var(--text-soft)}
  .sel,.inp{width:100%;border-radius:14px;border:1px solid var(--border);background:var(--surface);color:var(--text-strong);padding:10px 12px;font-size:13px;outline:none}
  .inp{text-align:right}
  .sel:focus,.inp:focus{box-shadow:0 0 0 2px var(--focus-ring)}
  .legend{border:1px solid var(--border);background:var(--surface-2);border-radius:24px;padding:18px}
  .lg{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--text-soft)}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:10px}
  .muted{color:var(--text-muted);font-size:12px}
  .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;font-size:11px;color:var(--text-muted)}
  .cal-grid{margin-top:8px;display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cell{height:80px;border-radius:18px;border:1px solid var(--border);background:var(--cell-bg);overflow:hidden}
  .day{height:100%;border-radius:inherit;padding:10px 12px;cursor:pointer;user-select:none;transition:background .15s}
  .day:hover{background:var(--cell-hover)}
  .cell.red{background:rgba(244,63,94,.15);border-color:rgba(244,63,94,.25)}
  .cell.yel{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.25)}
  .cell.grn{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.25)}
  .daytop{display:flex;justify-content:space-between;gap:8px}
  .dnum{font-size:14px;font-weight:800;color:var(--text-strong)}
  .drev{font-size:11px;color:var(--text-soft);font-variant-numeric:tabular-nums}
  .small{margin-top:6px;font-size:11px;line-height:1.25;color:var(--text-soft)}
  .cal-nav{margin-top:14px;display:flex;justify-content:space-between;gap:12px;align-items:center}
  .mid{font-size:13px;color:var(--text-mid)}
  .split{display:grid;gap:16px}
  @media (min-width:768px){.split{grid-template-columns:1fr 1fr}}
  .section{border:1px solid var(--border);background:var(--surface-2);border-radius:18px;padding:14px}
  .secTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
  .secT{font-size:13px;font-weight:700;color:var(--text-strong)}
  .secS{font-size:12px;color:var(--text-muted);margin-top:6px}
  .tableWrap{margin-top:12px;border:1px solid var(--border);border-radius:18px;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
  th,td{padding:10px 12px;border-top:1px solid var(--border)}
  thead th{border-top:none;background:var(--thead-bg);color:var(--text-mid);font-weight:700}
  tfoot td{background:var(--thead-bg);font-weight:800;color:var(--text-strong)}
  td.r,th.r{text-align:right;font-variant-numeric:tabular-nums}
  td.tr{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .miniIn{padding:8px 10px;border-radius:12px}
  .modal{position:fixed;inset:0;z-index:99999;display:none}
  .modal.on{display:block}
  .back{position:absolute;inset:0;background:var(--backdrop)}
  .sheet{position:absolute;inset:0;padding:16px;overflow:auto}
  .dialog{max-width:980px;margin:0 auto;border-radius:24px;border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow-dialog);overflow:hidden}
  .dlgH{padding:18px 18px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .dlgB{padding:18px}
  .role{border:1px solid var(--border);background:var(--surface-2);border-radius:18px;padding:14px}
  .roleTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
  .roleT{font-size:13px;font-weight:800;color:var(--text-strong)}
  .roleS{font-size:11px;color:var(--text-muted);margin-top:6px}
  .add{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--surface-2);color:var(--text-soft);cursor:pointer;font-weight:700}
  .del{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(244,63,94,.12);color:#fecdd3;cursor:pointer;font-weight:800}
  .rgrid{margin-top:10px;display:grid;grid-template-columns:repeat(14,1fr);gap:8px;align-items:center}
  .col4{grid-column:span 4}
  .col2{grid-column:span 2}
  .payout{text-align:right}
  .pTop{font-weight:800;color:var(--text-strong);font-variant-numeric:tabular-nums}
  .pSub{font-size:11px;color:var(--text-muted);font-variant-numeric:tabular-nums;margin-top:4px}
  .hint{font-size:11px;color:var(--text-muted);margin-top:10px}
</style>

<script>
(function(){
  const el=document.getElementById("fot-app");
  if(!el) return;

  const MONTHS=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
  const ADMINS=["Кристина","Михаил","Дарья"];
  const KMS=["Юра","Рудольф","Женя","Леонид","Дарья"];
  const MANAGER_NAME="Дарья";
  const DEFAULT_RATES={
    tier1:{admin:"8",km_main:"10",km_support:"7",km_support2:"7"},
    tier2:{admin:"7.5",km_main:"9",km_support:"6",km_support2:"6"},
    tier3:{admin:"6.5",km_main:"8",km_support:"5",km_support2:"5"},
  };
  const WEEKDAYS=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];
  const STORAGE_KEY="tilda:fot:store:v15";
  const THEME_KEY="tilda:fot:theme:v1";

  const pad2=n=>String(n).padStart(2,"0");
  const monthKey=(y,m)=>`${y}-${pad2(m+1)}`;
  const wd=d=>WEEKDAYS[d]||"";
  const numStr=x=>String(x??"").trim().split("").map(ch=>ch===","
    ?".":(ch==="₽"?"":ch)).join("").replace(/[^0-9.\-]/g,"");
  const n0=x=>{const v=Number(numStr(x));return Number.isFinite(v)?Math.max(0,v):0;};
  const m0=x=>{const v=Number(numStr(x));return Number.isFinite(v)?v:0;};
  const h0=x=>{const v=Number(numStr(x));return Number.isFinite(v)?Math.max(0,v):0;};
  const money=n=>Number.isFinite(n)
    ?new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}).format(Math.round(n))
    :"—";
  const isFriSat=dt=>{const d=dt.getDay();return d===5||d===6;};
  const defHours=role=>role==="admin"?11:role==="km_main"?13:role==="km_support"?7:role==="km_support2"?5:0;

  const normalizeRates=r=>{
    const src=r&&typeof r==="object"?r:{};
    const pick=(tier,key)=>String((src[tier]||{})[key]??DEFAULT_RATES[tier][key]);
    return{
      tier1:{admin:pick("tier1","admin"),km_main:pick("tier1","km_main"),km_support:pick("tier1","km_support"),km_support2:pick("tier1","km_support2")},
      tier2:{admin:pick("tier2","admin"),km_main:pick("tier2","km_main"),km_support:pick("tier2","km_support"),km_support2:pick("tier2","km_support2")},
      tier3:{admin:pick("tier3","admin"),km_main:pick("tier3","km_main"),km_support:pick("tier3","km_support"),km_support2:pick("tier3","km_support2")},
    };
  };
  const normalizeInv=inv=>{
    const a=(inv&&inv.admin)||{}, k=(inv&&inv.km)||{};
    return{admin:{snacks:String(a.snacks??""),drinks:String(a.drinks??""),beer:String(a.beer??""),bar:String(a.bar??"")},km:{tobacco:String(k.tobacco??"")}};
  };
  const normalizeAdv=adv=>{
    const base={}; [...ADMINS,...KMS].forEach(n=>base[n]="");
    const src=adv&&typeof adv==="object"?adv:{};
    Object.keys(base).forEach(n=>base[n]=String(src[n]??""));
    return base;
  };
  const normalizeAdminSalary=sal=>{
    const base={}; ADMINS.forEach(n=>base[n]="");
    const src=sal&&typeof sal==="object"?sal:{};
    ADMINS.forEach(n=>base[n]=String(src[n]??""));
    return base;
  };

  const defDay=dt=>({
    admin:[{name:ADMINS[0],hours:String(defHours("admin")),breakage:"0",bonus:"0"}],
    km_main:[{name:KMS[0],hours:String(defHours("km_main")),breakage:"0",bonus:"0"}],
    km_support:[{name:KMS[0],hours:String(defHours("km_support")),breakage:"0",bonus:"0"}],
    km_support2:isFriSat(dt)?[{name:KMS[0],hours:String(defHours("km_support2")),breakage:"0",bonus:"0"}]:[],
  });

  const alloc=(total,rows)=>{
    const hs=(rows||[]).map(r=>h0(r&&r.hours));
    const s=hs.reduce((a,b)=>a+b,0);
    if(s<=0) return (rows||[]).map(()=>0);
    return hs.map(h=>total*h/s);
  };

  const sumHours=(rows)=> (Array.isArray(rows)?rows:[]).reduce((a,r)=>a + h0(r && r.hours), 0);

  const safeGet=()=>{try{const raw=localStorage.getItem(STORAGE_KEY);const p=raw?JSON.parse(raw):null;return p&&typeof p==="object"?p:{months:{}};}catch(e){return{months:{}};}};
  const safeSet=obj=>{try{localStorage.setItem(STORAGE_KEY,JSON.stringify(obj));}catch(e){}};
  const safeGetTheme=()=>{try{const t=localStorage.getItem(THEME_KEY);return t==="light"?"light":"dark";}catch(e){return"dark";}};
  const safeSetTheme=t=>{try{localStorage.setItem(THEME_KEY,t);}catch(e){}};

  const state={
    view:"dashboard",
    year:(new Date()).getFullYear(),
    month:(new Date()).getMonth(),
    rev:{},
    asgn:{},
    adv:normalizeAdv(null),
    inv:normalizeInv(null),
    rates:normalizeRates(null),
    manager:{percent:"",seniorBonus:""},
    adminSalary:normalizeAdminSalary(null),
    seniorKm:"",
    activeDay:null,
    loadedKey:null,
    hydrating:false,
    saveTimer:null,
    theme:safeGetTheme(),
  };

  const tierFrom=r=>r>=70000?{id:"tier3",name:"≥ 70 000"}:r>=50000?{id:"tier2",name:"50 000–69 999"}:{id:"tier1",name:"< 50 000"};

  const computeForDay=(revenue, assigns)=>{
    const tier=tierFrom(revenue);
    const rr=normalizeRates(state.rates)[tier.id];

    const a=n0(rr.admin)/100;
    const km=n0(rr.km_main)/100;
    const ks=n0(rr.km_support)/100;

    const adminTotal=revenue*a;
    const kmMainTotal=revenue*km;

    const supportPool=revenue*ks;

    const supHours=sumHours(assigns && assigns.km_support);
    const sup2Hours=sumHours(assigns && assigns.km_support2);

    let sup2Total=0;
    if(supHours>0 && sup2Hours>0){
      sup2Total=(supportPool/supHours)*sup2Hours;
      if(sup2Total>supportPool) sup2Total=supportPool;
    }

    return{tier,totals:{admin:adminTotal,km_main:kmMainTotal,km_support:supportPool,km_support2:sup2Total}};
  };

  const dim=()=>new Date(state.year,state.month+1,0).getDate();
  const key=()=>monthKey(state.year,state.month);

  const getDay=(d,dt)=>state.asgn[d]||defDay(dt);

  const scheduleSave=()=>{
    if(state.hydrating) return;
    if(state.saveTimer) clearTimeout(state.saveTimer);
    state.saveTimer=setTimeout(saveNow,200);
  };
  const saveNow=()=>{
    if(state.hydrating) return;
    const k=key();
    if(state.loadedKey!==k) return;
    const store=safeGet();
    const next={...store,months:{...(store.months||{})}};
    next.months[k]={
      rev:state.rev,
      asgn:state.asgn,
      adv:state.adv,
      inv:normalizeInv(state.inv),
      rates:normalizeRates(state.rates),
      manager:state.manager,
      adminSalary:state.adminSalary,
      seniorKm:state.seniorKm
    };
    safeSet(next);
  };

  const loadMonth=(k)=>{
    state.hydrating=true;
    const store=safeGet();
    const d=store.months&&store.months[k];
    if(!d){
      state.rev={};
      state.asgn={};
      state.adv=normalizeAdv(null);
      state.inv=normalizeInv(null);
      state.rates=normalizeRates(null);
      state.manager={percent:"",seniorBonus:""};
      state.adminSalary=normalizeAdminSalary(null);
      state.seniorKm="";
      state.activeDay=null;
      state.loadedKey=k;
      state.hydrating=false;
      render();
      return;
    }
    state.rev=d.rev||{};
    state.asgn=d.asgn||{};
    state.adv=normalizeAdv(d.adv);
    state.inv=normalizeInv(d.inv);
    state.rates=normalizeRates(d.rates);
    state.manager={percent:String((d.manager||{}).percent??""),seniorBonus:String((d.manager||{}).seniorBonus??"")};
    state.adminSalary=normalizeAdminSalary(d.adminSalary);
    state.seniorKm=String(d.seniorKm??"");
    state.activeDay=null;
    state.loadedKey=k;
    state.hydrating=false;
    render();
  };

  const shiftMonth=delta=>{
    const d=new Date(state.year,state.month+delta,1);
    state.year=d.getFullYear();
    state.month=d.getMonth();
    loadMonth(key());
  };

  const tierClass=rev=>rev>=70000?"grn":rev>=50000?"yel":"red";

  const uniqNames=rows=>{
    const out=[]; const s=new Set();
    (rows||[]).forEach(r=>{
      const n=String((r&&r.name)||"").trim();
      if(!n||s.has(n)) return;
      s.add(n); out.push(n);
    });
    return out;
  };

  const calcMonthTotals=()=>{
    let revenue=0, fotNet=0;
    const sumField=(arr,field)=>(arr||[]).reduce((a,r)=>a+Math.max(0,m0(r&&r[field])),0);
    const days=dim();
    for(let d=1; d<=days; d++){
      const dt=new Date(state.year,state.month,d);
      const r=n0(state.rev[d]);
      revenue+=r;
      const a=getDay(d,dt);
      const {totals}=computeForDay(r,a);
      const br=sumField(a.admin,"breakage")+sumField(a.km_main,"breakage")+sumField(a.km_support,"breakage")+sumField(a.km_support2,"breakage");
      const pr=sumField(a.admin,"bonus")+sumField(a.km_main,"bonus")+sumField(a.km_support,"bonus")+sumField(a.km_support2,"bonus");
      const gross=totals.admin+totals.km_main+totals.km_support+totals.km_support2;
      fotNet+=gross+pr-br;
    }
    return{revenue,fotNet};
  };

  const calcPeopleTotals=()=>{
    const adminTotals={}; const kmTotals={};
    ADMINS.forEach(n=>adminTotals[n]={gross:0,breakage:0});
    KMS.forEach(n=>kmTotals[n]={gross:0,breakage:0});

    const add=(roleTotal,roleRows,target)=>{
      const rr=Array.isArray(roleRows)?roleRows:[];
      const payouts=alloc(roleTotal,rr);
      for(let i=0;i<rr.length;i++){
        const name=String((rr[i]&&rr[i].name)||"").trim();
        if(!name) continue;
        if(!target[name]) target[name]={gross:0,breakage:0};
        const b=Math.max(0,m0(rr[i]&&rr[i].bonus));
        target[name].gross+=(payouts[i]||0)+b;
        target[name].breakage+=Math.max(0,m0(rr[i]&&rr[i].breakage));
      }
    };

    const days=dim();
    for(let d=1; d<=days; d++){
      const dt=new Date(state.year,state.month,d);
      const r=n0(state.rev[d]);
      const a=state.asgn[d]||defDay(dt);
      const {totals}=computeForDay(r,a);
      add(totals.admin,a.admin,adminTotals);
      add(totals.km_main,a.km_main,kmTotals);
      add(totals.km_support,a.km_support,kmTotals);
      add(totals.km_support2,a.km_support2,kmTotals);
    }
    return{adminTotals,kmTotals};
  };

  const html=(s)=>String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));

  function render(){
    const pageBg=state.theme==="light"?"#f5f7fb":"#09090b";
    document.body.style.background=pageBg;
    document.documentElement.style.background=pageBg;

    const days=dim();
    const mk=key();
    const mt=calcMonthTotals();
    const pt=calcPeopleTotals();

    const cal=(()=>{
      const fd=new Date(state.year,state.month,1);
      const start=fd.getDay();
      const total=Math.ceil((start+days)/7)*7;
      let h=`<div class="card"><div class="card-h"><div><div class="t">Календарь</div><div class="st">Клик по дню — открыть редактор</div></div></div><div class="card-b">`;
      h+=`<div class="cal-head">${WEEKDAYS.map(w=>`<div>${w}</div>`).join("")}</div>`;
      h+=`<div class="cal-grid">`;
      for(let i=0;i<total;i++){
        const d=i-start+1;
        if(d<1||d>days){ h+=`<div class="cell"></div>`; continue; }
        const dt=new Date(state.year,state.month,d);
        const rev=n0(state.rev[d]);
        const a=getDay(d,dt);
        const admins=uniqNames(a.admin).join(", ")||"—";
        const kms=uniqNames([...(a.km_main||[]),...(a.km_support||[]),...(a.km_support2||[])]).join(", ")||"—";
        const cls=tierClass(rev);
        h+=`<div class="cell ${cls}"><div class="day" data-act="openDay" data-day="${d}">`;
        h+=`<div class="daytop"><div class="dnum">${d}</div><div class="drev">${rev?html(money(rev)):""}</div></div>`;
        h+=`<div class="small"><div>А: ${html(admins)}</div><div>КМ: ${html(kms)}</div></div>`;
        h+=`</div></div>`;
      }
      h+=`</div>`;
      h+=`<div class="cal-nav"><button class="btn ghost" data-act="prevMonth">← Пред.</button><div class="mid">${MONTHS[state.month]} ${state.year}</div><button class="btn ghost" data-act="nextMonth">След. →</button></div>`;
      h+=`</div></div>`;
      return h;
    })();

    const settings=(()=>{
      const r=normalizeRates(state.rates);
      const tiers=[{id:"tier1",t:"< 50 000"},{id:"tier2",t:"50 000–69 999"},{id:"tier3",t:"≥ 70 000"}];
      let h=`<div class="card"><div class="card-h"><div><div class="t">Настройки</div><div class="st">Процентные ставки по тарифам</div></div></div><div class="card-b"><div class="row">`;
      tiers.forEach(x=>{
        h+=`<div class="section"><div class="secT">${x.t}</div><div class="row2" style="margin-top:12px">`;
        h+=`<div><div class="muted" style="margin-bottom:6px">Админ %</div><input class="inp" data-act="setRate" data-tier="${x.id}" data-key="admin" value="${html(r[x.id].admin)}"></div>`;
        h+=`<div><div class="muted" style="margin-bottom:6px">КМ осн %</div><input class="inp" data-act="setRate" data-tier="${x.id}" data-key="km_main" value="${html(r[x.id].km_main)}"></div>`;
        h+=`<div><div class="muted" style="margin-bottom:6px">КМ сап %</div><input class="inp" data-act="setRate" data-tier="${x.id}" data-key="km_support" value="${html(r[x.id].km_support)}"></div>`;
        h+=`<div><div class="muted" style="margin-bottom:6px">КМ сап² %</div><input class="inp" data-act="setRate" data-tier="${x.id}" data-key="km_support2" value="${html(r[x.id].km_support2)}"></div>`;
        h+=`</div></div>`;
      });
      h+=`</div></div></div>`;
      return h;
    })();

    const people=(()=>{
      const inv=normalizeInv(state.inv);
      const adminInv=n0(inv.admin.snacks)+n0(inv.admin.drinks)+n0(inv.admin.beer)+n0(inv.admin.bar);
      const kmInv=n0(inv.km.tobacco);
      const adminShare=ADMINS.length?adminInv/ADMINS.length:0;
      const kmShare=KMS.length?kmInv/KMS.length:0;

      const adminRows=ADMINS.map(name=>{
        const gross=(pt.adminTotals[name]||{}).gross||0;
        const boj=(pt.adminTotals[name]||{}).breakage||0;
        const adv=Math.max(0,m0(state.adv[name]));
        const salary=Math.max(0,m0(state.adminSalary[name]));
        const net=gross - boj - adv - adminShare + salary;
        return{ name,gross,boj,adv,salary,net };
      });

      const kmRows=KMS.map(name=>{
        const gross=(pt.kmTotals[name]||{}).gross||0;
        const boj=(pt.kmTotals[name]||{}).breakage||0;
        const adv=Math.max(0,m0(state.adv[name]));
        const extra=(name==="Юра")?Math.max(0,m0(state.seniorKm)):0;
        const net=gross - boj - adv - kmShare + extra;
        return{ name,gross,boj,adv,extra,net };
      });

      const sum=(arr,k)=>arr.reduce((a,r)=>a+(r[k]||0),0);

      let h=`<div class="card"><div class="card-h"><div><div class="t">Сводка сотрудников</div><div class="st">Оклады/авансы/инвентаризация/доплаты</div></div></div><div class="card-b"><div class="row">`;

      h+=`<div class="section"><div class="secTop"><div><div class="secT">Администраторы</div><div class="secS">Инвентаризация: ${html(money(adminInv))} · по ${html(money(adminShare))}</div></div>`;
      h+=`<div style="width:min(280px,100%)"><div class="row2">`;
      h+=`<input class="inp miniIn" placeholder="Снэки" data-act="setInvA" data-key="snacks" value="${html(inv.admin.snacks)}">`;
      h+=`<input class="inp miniIn" placeholder="Напитки" data-act="setInvA" data-key="drinks" value="${html(inv.admin.drinks)}">`;
      h+=`<input class="inp miniIn" placeholder="Пиво" data-act="setInvA" data-key="beer" value="${html(inv.admin.beer)}">`;
      h+=`<input class="inp miniIn" placeholder="Бар" data-act="setInvA" data-key="bar" value="${html(inv.admin.bar)}">`;
      h+=`</div></div></div>`;

      h+=`<div class="tableWrap"><table><thead><tr>`;
      h+=`<th style="width:28%">Сотр.</th><th class="r" style="width:16%">Нач.</th><th class="r" style="width:16%">Оклад</th><th class="r" style="width:14%">Бой</th><th class="r" style="width:14%">Аванс</th><th class="r" style="width:12%">Итог</th>`;
      h+=`</tr></thead><tbody>`;
      adminRows.forEach(r=>{
        h+=`<tr><td class="tr">${html(r.name)}</td><td class="r">${html(money(r.gross))}</td>`;
        h+=`<td class="r"><input class="inp miniIn" data-act="setAdminSalary" data-name="${html(r.name)}" value="${html(state.adminSalary[r.name]||"")}"></td>`;
        h+=`<td class="r">${html(money(r.boj))}</td>`;
        h+=`<td class="r"><input class="inp miniIn" data-act="setAdvance" data-name="${html(r.name)}" value="${html(state.adv[r.name]||"")}"></td>`;
        h+=`<td class="r" style="font-weight:800">${html(money(r.net))}</td></tr>`;
      });
      h+=`</tbody><tfoot><tr><td>Итого</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"gross")))}</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"salary")))}</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"boj")))}</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"adv")))}</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"net")))}</td></tr></tfoot></table></div></div>`;

      h+=`<div class="section"><div class="secTop"><div><div class="secT">Кальянные мастера</div><div class="secS">Инвентаризация: ${html(money(kmInv))} · по ${html(money(kmShare))}</div></div>`;
      h+=`<div style="width:min(280px,100%)">`;
      h+=`<div class="muted" style="margin-bottom:6px">Доплата старшему (Юра)</div>`;
      h+=`<input class="inp miniIn" data-act="setSeniorKm" value="${html(state.seniorKm||"")}">`;
      h+=`<div style="margin-top:10px"><input class="inp miniIn" placeholder="Табак" data-act="setInvK" value="${html(inv.km.tobacco)}"></div>`;
      h+=`</div></div>`;

      h+=`<div class="tableWrap"><table><thead><tr>`;
      h+=`<th style="width:28%">Сотр.</th><th class="r" style="width:18%">Нач.</th><th class="r" style="width:16%">Плюс</th><th class="r" style="width:14%">Бой</th><th class="r" style="width:14%">Аванс</th><th class="r" style="width:10%">Итог</th>`;
      h+=`</tr></thead><tbody>`;
      kmRows.forEach(r=>{
        h+=`<tr><td class="tr">${html(r.name)}</td><td class="r">${html(money(r.gross))}</td><td class="r">${html(money(r.extra))}</td>`;
        h+=`<td class="r">${html(money(r.boj))}</td>`;
        h+=`<td class="r"><input class="inp miniIn" data-act="setAdvance" data-name="${html(r.name)}" value="${html(state.adv[r.name]||"")}"></td>`;
        h+=`<td class="r" style="font-weight:800">${html(money(r.net))}</td></tr>`;
      });
      h+=`</tbody><tfoot><tr><td>Итого</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"gross")))}</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"extra")))}</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"boj")))}</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"adv")))}</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"net")))}</td></tr></tfoot></table></div></div>`;

      h+=`</div></div></div>`;
      return h;
    })();

    const manager=(()=>{
      const pct=n0(state.manager.percent);
      const pay=mt.revenue*pct/100;
      const senior=Math.max(0,m0(state.manager.seniorBonus));
      let h=`<div class="card"><div class="card-h"><div><div class="t">Управляющая</div><div class="st">${MANAGER_NAME} · Итог: ${html(money(pay+senior))}</div></div></div><div class="card-b">`;
      h+=`<div class="row2">`;
      h+=`<div><div class="muted" style="margin-bottom:6px">Процент от выручки месяца (%)</div><input class="inp" data-act="setManager" data-key="percent" value="${html(state.manager.percent||"")}"></div>`;
      h+=`<div><div class="muted" style="margin-bottom:6px">Доплата старшего администратора</div><input class="inp" data-act="setManager" data-key="seniorBonus" value="${html(state.manager.seniorBonus||"")}"></div>`;
      h+=`</div>`;
      h+=`<div class="section" style="margin-top:12px"><div class="muted">Расчёт</div><div style="margin-top:6px;font-size:18px;font-weight:900">${html(money(pay+senior))}</div><div class="muted" style="margin-top:6px">${html(money(pay))} + ${html(money(senior))}</div></div>`;
      h+=`</div></div>`;
      return h;
    })();

    const totals=(()=>{
      let h=`<div class="card"><div class="card-h"><div><div class="t">Итого</div><div class="st">Сводка месяца</div></div></div><div class="card-b"><div class="row">`;
      h+=`<div class="section"><div class="muted">Выручка</div><div style="margin-top:6px;font-size:22px;font-weight:900">${html(money(mt.revenue))}</div></div>`;
      h+=`<div class="section"><div class="muted">ФОТ (нетто)</div><div style="margin-top:6px;font-size:22px;font-weight:900">${html(money(mt.fotNet))}</div></div>`;
      h+=`</div></div></div>`;
      return h;
    })();

    const sidebar=(()=>{
      const now=new Date();
      const yopts=Array.from({length:8}).map((_,i)=>now.getFullYear()-4+i);
      let h=`<div class="card"><div class="card-h"><div><div class="t">ФОТ-калькулятор (Все Свои)</div><div class="st">Выручка: ${html(money(mt.revenue))} · ФОТ: ${html(money(mt.fotNet))}</div></div><div class="chip">${mk}</div></div><div class="card-b">`;
      h+=`<div class="row2">`;
      h+=`<select class="sel" data-act="setYear">${yopts.map(y=>`<option value="${y}" ${y===state.year?"selected":""}>${y}</option>`).join("")}</select>`;
      h+=`<select class="sel" data-act="setMonth">${MONTHS.map((m,i)=>`<option value="${i}" ${i===state.month?"selected":""}>${html(m)}</option>`).join("")}</select>`;
      h+=`</div>`;
      h+=`<div class="tabs">`;
      h+=`<div class="pill ${state.view==="dashboard"?"on":"off"}" data-act="setView" data-view="dashboard">Дашборд</div>`;
      h+=`<div class="pill ${state.view==="settings"?"on":"off"}" data-act="setView" data-view="settings">Настройки</div>`;
      h+=`</div>`;
      h+=`<div class="muted" style="margin-top:12px">Тема</div>`;
      h+=`<div class="tabs">`;
      h+=`<div class="pill ${state.theme==="dark"?"on":"off"}" data-act="setTheme" data-theme="dark">Тёмная</div>`;
      h+=`<div class="pill ${state.theme==="light"?"on":"off"}" data-act="setTheme" data-theme="light">Светлая</div>`;
      h+=`</div>`;
      h+=`<div style="margin-top:14px"><button class="btn primary" style="width:100%" data-act="clearMonth">Очистить месяц</button></div>`;
      h+=`</div></div>`;

      h+=`<div class="legend"><div class="t">Легенда тарифов</div>`;
      h+=`<div style="margin-top:12px" class="row">`;
      h+=`<div class="lg"><div><span class="dot" style="background:rgba(244,63,94,.65)"></span>&lt; 50 000</div><div class="muted">красный</div></div>`;
      h+=`<div class="lg"><div><span class="dot" style="background:rgba(245,158,11,.65)"></span>50 000–69 999</div><div class="muted">жёлтый</div></div>`;
      h+=`<div class="lg"><div><span class="dot" style="background:rgba(16,185,129,.65)"></span>≥ 70 000</div><div class="muted">зелёный</div></div>`;
      h+=`</div><div class="hint">Сохранение: localStorage (по месяцам).</div></div>`;
      return h;
    })();

    const main=(()=>{
      if(state.view==="settings") return `<div class="row">${settings}</div>`;
      return `<div class="row">${cal}${people}<div class="split">${manager}${totals}</div></div>`;
    })();

    const modal=(()=>{
      const open=state.activeDay!=null;
      const d=state.activeDay;
      const dt=open?new Date(state.year,state.month,d):null;
      const rev=n0(open?state.rev[d]:0);
      const assigns=open?getDay(d,dt):null;
      const c=open?computeForDay(rev, assigns):{tier:{id:"tier1",name:"< 50 000"},totals:{admin:0,km_main:0,km_support:0,km_support2:0}};
      const tier=c.tier, totals=c.totals;

      const rolePanel=(title,roleKey,people,total,rows,allowEmpty)=>{
        const rr=Array.isArray(rows)?rows:[];
        const payouts=alloc(total,rr);
        const br=rr.map(r=>Math.max(0,m0(r&&r.breakage)));
        const bn=rr.map(r=>Math.max(0,m0(r&&r.bonus)));
        const net=payouts.map((p,i)=>p-(br[i]||0)+(bn[i]||0));

        let h=`<div class="role" data-role="${roleKey}"><div class="roleTop"><div><div class="roleT">${html(title)}</div><div class="roleS">Сумма роли: ${html(money(total))}</div></div>`;
        h+=`<button class="add" data-act="addRow" data-role="${roleKey}">+ Добавить</button></div>`;
        if(rr.length===0 && allowEmpty) h+=`<div class="hint">Нет записей. Добавь человека, если роль была в этот день.</div>`;

        rr.forEach((r,idx)=>{
          h+=`<div class="rgrid">`;
          h+=`<div class="col2"><button class="del" data-act="delRow" data-role="${roleKey}" data-idx="${idx}">Удалить</button></div>`;
          h+=`<div class="col4"><select class="sel" data-act="setRow" data-role="${roleKey}" data-idx="${idx}" data-field="name">`+
            people.map(p=>`<option value="${html(p)}" ${p===(r.name||"")?"selected":""}>${html(p)}</option>`).join("")+
            `</select></div>`;
          h+=`<div class="col2"><input class="inp" data-act="setRow" data-role="${roleKey}" data-idx="${idx}" data-field="hours" value="${html(r.hours??"")}"></div>`;
          h+=`<div class="col2"><input class="inp" data-act="setRow" data-role="${roleKey}" data-idx="${idx}" data-field="bonus" value="${html(r.bonus??"0")}" placeholder="Премия"></div>`;
          h+=`<div class="col2"><input class="inp" data-act="setRow" data-role="${roleKey}" data-idx="${idx}" data-field="breakage" value="${html(r.breakage??"0")}" placeholder="Бой"></div>`;
          h+=`<div class="col2 payout"><div class="pTop">${html(money(net[idx]||0))}</div><div class="pSub">${html(money(payouts[idx]||0))} + ${html(money(bn[idx]||0))} − ${html(money(br[idx]||0))}</div></div>`;
          h+=`</div>`;
        });

        h+=`</div>`;
        return h;
      };

      let h=`<div class="modal ${open?"on":""}" id="fot-modal"><div class="back" data-act="closeModal"></div><div class="sheet"><div class="dialog">`;
      h+=`<div class="dlgH"><div><div class="t">${open?`Редактор дня · ${state.year}-${pad2(state.month+1)}-${pad2(d)} (${wd(dt.getDay())})`:"Редактор дня"}</div>`;
      h+=`<div class="st">${open?`Тариф: ${tier.name} · Выручка: ${money(rev)} · Роли: ${money(totals.admin+totals.km_main+totals.km_support+totals.km_support2)}`:""}</div></div>`;
      h+=`<button class="btn ghost" data-act="closeModal">Закрыть</button></div>`;
      h+=`<div class="dlgB">`;

      if(open){
        h+=`<div class="section" style="margin-bottom:12px"><div class="muted" style="margin-bottom:6px">Выручка дня</div>`;
        h+=`<input class="inp" data-act="setDayRevenue" value="${html(state.rev[d]??"")}" placeholder="0">`;
        h+=`<div class="muted" style="margin-top:8px">Сейчас: ${html(money(rev))} · Тариф: ${html(tier.name)}</div></div>`;

        h+=rolePanel("Администратор","admin",ADMINS,totals.admin,assigns.admin,false);
        h+=`<div style="height:10px"></div>`;
        h+=rolePanel("Кальянный мастер","km_main",KMS,totals.km_main,assigns.km_main,false);
        h+=`<div style="height:10px"></div>`;
        h+=rolePanel("КМ саппорт","km_support",KMS,totals.km_support,assigns.km_support,false);
        h+=`<div style="height:10px"></div>`;
        h+=rolePanel("КМ саппорт²","km_support2",KMS,totals.km_support2,assigns.km_support2,true);
      }

      h+=`</div></div></div></div></div>`;
      return h;
    })();

    el.innerHTML=`<div class="bg theme-${state.theme}"><div class="wrap"><div class="grid"><div>${sidebar}</div><div class="min">${main}</div></div></div>${modal}</div>`;
  }

  function renderKeepFocus(){
    const root=el;
    const ae=document.activeElement;
    const inside=ae && root.contains(ae);
    const sx=window.scrollX;
    const sy=window.scrollY;

    let sel=null, ss=null, se=null;
    if(inside && ae.getAttribute){
      const act=ae.getAttribute("data-act");
      if(act){
        const parts=["[data-act='"+act+"']"];
        const attrs=["data-day","data-name","data-tier","data-key","data-role","data-idx","data-field","data-view"];
        attrs.forEach(a=>{
          const v=ae.getAttribute(a);
          if(v!=null) parts.push("["+a+"='"+CSS.escape(v)+"']");
        });
        sel=parts.join("");
      }
      if(typeof ae.selectionStart==="number"){
        ss=ae.selectionStart;
        se=ae.selectionEnd;
      }
    }

    render();

    if(sel){
      const el2=root.querySelector(sel);
      if(el2 && el2.focus){
        el2.focus({preventScroll:true});
        if(ss!=null && typeof el2.setSelectionRange==="function"){
          const len=(el2.value||"").length;
          const a=Math.min(ss,len);
          const b=Math.min(se==null?ss:se,len);
          try{ el2.setSelectionRange(a,b); }catch(e){}
        }
      }
    }
    window.scrollTo(sx,sy);
  }

  function setAssignDay(day,next){
    state.asgn={...state.asgn,[day]:next};
    scheduleSave();
  }

  function ensureDay(day){
    const dt=new Date(state.year,state.month,day);
    if(!state.asgn[day]) state.asgn={...state.asgn,[day]:defDay(dt)};
  }

  el.addEventListener("click",(e)=>{
    const t=e.target.closest("[data-act]");
    if(!t) return;
    const act=t.getAttribute("data-act");

    if(act==="setView"){
      state.view=t.getAttribute("data-view");
      state.activeDay=null;
      render();
      return;
    }
    if(act==="setTheme"){
      state.theme=t.getAttribute("data-theme")==="light"?"light":"dark";
      safeSetTheme(state.theme);
      render();
      return;
    }
    if(act==="clearMonth"){
      state.rev={}; state.asgn={}; state.activeDay=null;
      scheduleSave();
      render();
      return;
    }
    if(act==="openDay"){
      const d=Number(t.getAttribute("data-day"));
      state.activeDay=d;
      ensureDay(d);
      render();
      return;
    }
    if(act==="closeModal"){
      state.activeDay=null;
      render();
      return;
    }
    if(act==="prevMonth"){ shiftMonth(-1); return; }
    if(act==="nextMonth"){ shiftMonth(1); return; }

    if(act==="addRow"){
      const role=t.getAttribute("data-role");
      const d=state.activeDay;
      if(!d) return;
      ensureDay(d);
      const day=state.asgn[d];
      const people=(role==="admin")?ADMINS:KMS;
      const next={...day,[role]:[...(day[role]||[]),{name:people[0],hours:String(defHours(role)),breakage:"0",bonus:"0"}]};
      setAssignDay(d,next);
      render();
      return;
    }

    if(act==="delRow"){
      const role=t.getAttribute("data-role");
      const idx=Number(t.getAttribute("data-idx"));
      const d=state.activeDay;
      if(!d) return;
      ensureDay(d);
      const day=state.asgn[d];
      const arr=(day[role]||[]).slice();
      if(idx>=0 && idx<arr.length) arr.splice(idx,1);
      setAssignDay(d,{...day,[role]:arr});
      render();
      return;
    }
  });

  el.addEventListener("change",(e)=>{
    const t=e.target;
    if(!(t instanceof HTMLElement)) return;

    if(t.matches("select[data-act='setYear']")){
      state.year=Number(t.value);
      loadMonth(key());
      return;
    }
    if(t.matches("select[data-act='setMonth']")){
      state.month=Number(t.value);
      loadMonth(key());
      return;
    }
    if(t.matches("select[data-act='setRow']")){
      const role=t.getAttribute("data-role");
      const idx=Number(t.getAttribute("data-idx"));
      const field=t.getAttribute("data-field");
      const d=state.activeDay; if(!d) return;
      ensureDay(d);
      const day=state.asgn[d];
      const arr=(day[role]||[]).slice();
      const row={...arr[idx],[field]:t.value};
      arr[idx]=row;
      setAssignDay(d,{...day,[role]:arr});
      render();
      return;
    }
  });

  el.addEventListener("input",(e)=>{
    const t=e.target;
    if(!(t instanceof HTMLElement)) return;

    if(t.matches("input[data-act='setDayRevenue']")){
      const d=state.activeDay; if(!d) return;
      state.rev={...state.rev,[d]:t.value};
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setRate']")){
      const tier=t.getAttribute("data-tier");
      const key2=t.getAttribute("data-key");
      const r=normalizeRates(state.rates);
      r[tier][key2]=t.value;
      state.rates=r;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setInvA']")){
      const k=t.getAttribute("data-key");
      const inv=normalizeInv(state.inv);
      inv.admin[k]=t.value;
      state.inv=inv;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setInvK']")){
      const inv=normalizeInv(state.inv);
      inv.km.tobacco=t.value;
      state.inv=inv;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setAdvance']")){
      const name=t.getAttribute("data-name");
      const adv=normalizeAdv(state.adv);
      adv[name]=t.value;
      state.adv=adv;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setAdminSalary']")){
      const name=t.getAttribute("data-name");
      const sal=normalizeAdminSalary(state.adminSalary);
      sal[name]=t.value;
      state.adminSalary=sal;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setSeniorKm']")){
      state.seniorKm=t.value;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setManager']")){
      const k=t.getAttribute("data-key");
      state.manager={...state.manager,[k]:t.value};
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setRow']")){
      const role=t.getAttribute("data-role");
      const idx=Number(t.getAttribute("data-idx"));
      const field=t.getAttribute("data-field");
      const d=state.activeDay; if(!d) return;
      ensureDay(d);
      const day=state.asgn[d];
      const arr=(day[role]||[]).slice();
      const row={...arr[idx],[field]:t.value};
      arr[idx]=row;
      setAssignDay(d,{...day,[role]:arr});
      renderKeepFocus();
      return;
    }
  });

  window.addEventListener("keydown",(e)=>{
    if(e.key==="Escape" && state.activeDay!=null){
      state.activeDay=null;
      render();
    }
  });

  loadMonth(key());
})();
</script>
</body>
</html>
