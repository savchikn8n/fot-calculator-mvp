<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FOT legacy</title>
  <style>html,body{margin:0;height:100%;background:#09090b}</style>
</head>
<body>
  <div id="fot-app"></div>
<style>
  #fot-app{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    --bg:#09090b;
    --surface:#09090b;
    --surface-2:rgba(9,9,11,.35);
    --surface-3:rgba(9,9,11,.45);
    --card-bg:rgba(9,9,11,.65);
    --border:#27272a;
    --text:#f4f4f5;
    --text-strong:#fafafa;
    --text-soft:#e4e4e7;
    --text-muted:#a1a1aa;
    --text-mid:#d4d4d8;
    --pill-on-bg:#fafafa;
    --pill-on-text:#09090b;
    --pill-off-bg:rgba(9,9,11,.35);
    --btn-primary-bg:#fafafa;
    --btn-primary-text:#09090b;
    --backdrop:rgba(0,0,0,.62);
    --shadow-card:0 18px 40px rgba(0,0,0,.35);
    --shadow-dialog:0 30px 80px rgba(0,0,0,.7);
    --focus-ring:rgba(113,113,122,.7);
    --cell-bg:rgba(9,9,11,.25);
    --cell-hover:rgba(9,9,11,.45);
    --thead-bg:rgba(9,9,11,.6);
  }
  #fot-app .theme-light{
    --bg:#f5f7fb;
    --surface:#ffffff;
    --surface-2:#f8fafc;
    --surface-3:#f1f5f9;
    --card-bg:#ffffff;
    --border:#d4d8e1;
    --text:#1f2937;
    --text-strong:#111827;
    --text-soft:#374151;
    --text-muted:#6b7280;
    --text-mid:#4b5563;
    --pill-on-bg:#111827;
    --pill-on-text:#ffffff;
    --pill-off-bg:#f3f4f6;
    --btn-primary-bg:#111827;
    --btn-primary-text:#ffffff;
    --backdrop:rgba(15,23,42,.35);
    --shadow-card:0 16px 30px rgba(15,23,42,.08);
    --shadow-dialog:0 28px 60px rgba(15,23,42,.16);
    --focus-ring:rgba(59,130,246,.35);
    --cell-bg:#f8fafc;
    --cell-hover:rgba(17,24,39,.08);
    --thead-bg:#f3f4f6;
  }
  #fot-app *{box-sizing:border-box}
  .bg{min-height:100vh;background:var(--bg);color:var(--text)}
  .wrap{max-width:1500px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:16px}
  @media (min-width:1024px){.grid{grid-template-columns:340px 1fr}}
  .card{border:1px solid var(--border);background:var(--card-bg);border-radius:24px;box-shadow:var(--shadow-card);overflow:hidden}
  .card-h{padding:18px 18px 10px;display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .card-b{padding:0 18px 18px}
  .t{font-size:13px;font-weight:600;color:var(--text-strong);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .st{font-size:12px;color:var(--text-muted);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chip{border:1px solid var(--border);background:var(--surface-3);border-radius:16px;padding:8px 10px;font-size:12px;color:var(--text-muted)}
  .row{display:grid;gap:12px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .pill{border-radius:999px;padding:8px 14px;font-size:13px;font-weight:600;cursor:pointer;user-select:none}
  .pill.on{background:var(--pill-on-bg);color:var(--pill-on-text)}
  .pill.off{background:var(--pill-off-bg);color:var(--text-soft);border:1px solid var(--border)}
  .btn{border-radius:16px;padding:12px 14px;font-size:13px;font-weight:700;cursor:pointer;border:1px solid var(--border)}
  .btn.primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);border-color:var(--btn-primary-bg)}
  .btn.ghost{background:var(--surface-2);color:var(--text-soft)}
  .btn.contrast{background:transparent;color:#ef4444;border-color:#ef4444}
  .sel,.inp{width:100%;border-radius:14px;border:1px solid var(--border);background:var(--surface);color:var(--text-strong);padding:10px 12px;font-size:13px;outline:none}
  .inp{text-align:right}
  .ta{width:100%;border-radius:14px;border:1px solid var(--border);background:var(--surface);color:var(--text-strong);padding:10px 12px;font-size:13px;outline:none;resize:vertical;min-height:88px;line-height:1.35}
  .ta:focus{box-shadow:0 0 0 2px var(--focus-ring)}
  .sel:focus,.inp:focus{box-shadow:0 0 0 2px var(--focus-ring)}
  .legend{border:1px solid var(--border);background:var(--surface-2);border-radius:24px;padding:18px}
  .lg{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--text-soft)}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:10px}
  .muted{color:var(--text-muted);font-size:12px}
  .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;font-size:11px;color:var(--text-muted)}
  .cal-grid{margin-top:8px;display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cell{height:80px;border-radius:18px;border:1px solid var(--border);background:var(--cell-bg);overflow:hidden}
  .day{height:100%;border-radius:inherit;padding:10px 12px;cursor:pointer;user-select:none;transition:background .15s}
  .day:hover{background:var(--cell-hover)}
  .cell.red{background:rgba(244,63,94,.15);border-color:rgba(244,63,94,.25)}
  .cell.yel{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.25)}
  .cell.grn{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.25)}
  .daytop{display:flex;justify-content:space-between;gap:8px}
  .dnum{font-size:14px;font-weight:800;color:var(--text-strong)}
  .drev{font-size:11px;color:var(--text-soft);font-variant-numeric:tabular-nums}
  .small{margin-top:6px;font-size:11px;line-height:1.25;color:var(--text-soft)}
  .cal-nav{margin-top:14px;display:flex;justify-content:space-between;gap:12px;align-items:center}
  .mid{font-size:13px;color:var(--text-mid)}
  .split{display:grid;gap:16px}
  @media (min-width:768px){.split{grid-template-columns:1fr 1fr}}
  .section{border:1px solid var(--border);background:var(--surface-2);border-radius:18px;padding:14px}
  .secTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
  .secT{font-size:13px;font-weight:700;color:var(--text-strong)}
  .secS{font-size:12px;color:var(--text-muted);margin-top:6px}
  .tableWrap{margin-top:12px;border:1px solid var(--border);border-radius:18px;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
  th,td{padding:10px 12px;border-top:1px solid var(--border)}
  thead th{border-top:none;background:var(--thead-bg);color:var(--text-mid);font-weight:700}
  tfoot td{background:var(--thead-bg);font-weight:800;color:var(--text-strong)}
  td.r,th.r{text-align:right;font-variant-numeric:tabular-nums}
  td.tr{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .miniIn{padding:8px 10px;border-radius:12px}
  .modal{position:fixed;inset:0;z-index:99999;display:none}
  .modal.on{display:block}
  .back{position:absolute;inset:0;background:var(--backdrop)}
  .sheet{position:absolute;inset:0;padding:16px;overflow:auto}
  .dialog{max-width:980px;margin:0 auto;border-radius:24px;border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow-dialog);overflow:hidden}
  .dlgH{padding:18px 18px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .dlgB{padding:18px}
  .role{border:1px solid var(--border);background:var(--surface-2);border-radius:18px;padding:14px}
  .roleTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
  .roleT{font-size:13px;font-weight:800;color:var(--text-strong)}
  .roleS{font-size:11px;color:var(--text-muted);margin-top:6px}
  .add{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--surface-2);color:var(--text-soft);cursor:pointer;font-weight:700}
  .del{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(244,63,94,.12);color:#fecdd3;cursor:pointer;font-weight:800}
  .rgrid{margin-top:10px;display:grid;grid-template-columns:repeat(14,1fr);gap:8px;align-items:center}
  .col4{grid-column:span 4}
  .col2{grid-column:span 2}
  .payout{text-align:right}
  .pTop{font-weight:800;color:var(--text-strong);font-variant-numeric:tabular-nums}
  .pSub{font-size:11px;color:var(--text-muted);font-variant-numeric:tabular-nums;margin-top:4px}
  .hint{font-size:11px;color:var(--text-muted);margin-top:10px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  const el=document.getElementById("fot-app");
  if(!el) return;

  const MONTHS=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
  let ADMINS=["Слесарева К.","Григорьев М.","Павлова Д."];
  let KMS=["Линиченко Ю.","Луя Р.","Золотарев Е.","Родин Л.","Павлова Д."];
  let MANAGER_NAME="Павлова Д.";
  let SENIOR_KM_NAME="Линиченко Ю.";
  const STAFF_DEFAULT=[
    {id:"adm-kristina",name:"Слесарева К.",fullName:"Слесарева Кристина",role:"admin",active:true},
    {id:"adm-mikhail",name:"Григорьев М.",fullName:"Григорьев Михаил",role:"admin",active:true},
    {id:"adm-darya",name:"Павлова Д.",fullName:"Павлова Дарья",role:"senior_admin",active:true},
    {id:"km-yura",name:"Линиченко Ю.",fullName:"Линиченко Юрий",role:"senior_km",active:true},
    {id:"km-rudolf",name:"Луя Р.",fullName:"Луя Рудольф",role:"km",active:true},
    {id:"km-evgeny",name:"Золотарев Е.",fullName:"Золотарев Евгений",role:"km",active:true},
    {id:"km-leonid",name:"Родин Л.",fullName:"Родин Леонид",role:"km",active:true},
    {id:"km-darya",name:"Павлова Д.",fullName:"Павлова Дарья",role:"km",active:true},
  ];
  const LEGACY_NAME_MAP={
    "Кристина":"Слесарева К.",
    "Михаил":"Григорьев М.",
    "Дарья":"Павлова Д.",
    "Юра":"Линиченко Ю.",
    "Рудольф":"Луя Р.",
    "Женя":"Золотарев Е.",
    "Леонид":"Родин Л."
  };
  const DEFAULT_RATES={
    tier1:{admin:"8",km_main:"10",km_support:"7",km_support2:"7"},
    tier2:{admin:"7.5",km_main:"9",km_support:"6",km_support2:"6"},
    tier3:{admin:"6.5",km_main:"8",km_support:"5",km_support2:"5"},
  };
  const WEEKDAYS=["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
  const STORAGE_KEY="tilda:fot:store:v15";
  const THEME_KEY="tilda:fot:theme:v1";
  const CONFIG_WAIT_MS=120;

  const pad2=n=>String(n).padStart(2,"0");
  const monthKey=(y,m)=>`${y}-${pad2(m+1)}`;
  const monIdx=d=>(d+6)%7;
  const wd=d=>WEEKDAYS[monIdx(d)]||"";
  const numStr=x=>String(x??"").trim().split("").map(ch=>ch===","
    ?".":(ch==="₽"?"":ch)).join("").replace(/[^0-9.\-]/g,"");
  const n0=x=>{const v=Number(numStr(x));return Number.isFinite(v)?Math.max(0,v):0;};
  const m0=x=>{const v=Number(numStr(x));return Number.isFinite(v)?v:0;};
  const h0=x=>{const v=Number(numStr(x));return Number.isFinite(v)?Math.max(0,v):0;};
  const money=n=>Number.isFinite(n)
    ?new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}).format(Math.round(n))
    :"—";
  const isFriSat=dt=>{const d=dt.getDay();return d===5||d===6;};
  const defHours=(role,dt)=>{
    const fs=isFriSat(dt);
    if(role==="admin") return fs?13:12;
    if(role==="km_main") return fs?15:14;
    if(role==="km_support") return fs?9:8;
    if(role==="km_support2") return 6;
    return 0;
  };

  const normalizeRates=r=>{
    const src=r&&typeof r==="object"?r:{};
    const pick=(tier,key)=>String((src[tier]||{})[key]??DEFAULT_RATES[tier][key]);
    return{
      tier1:{admin:pick("tier1","admin"),km_main:pick("tier1","km_main"),km_support:pick("tier1","km_support"),km_support2:pick("tier1","km_support2")},
      tier2:{admin:pick("tier2","admin"),km_main:pick("tier2","km_main"),km_support:pick("tier2","km_support"),km_support2:pick("tier2","km_support2")},
      tier3:{admin:pick("tier3","admin"),km_main:pick("tier3","km_main"),km_support:pick("tier3","km_support"),km_support2:pick("tier3","km_support2")},
    };
  };
  const normalizeInv=inv=>{
    const a=(inv&&inv.admin)||{}, k=(inv&&inv.km)||{};
    return{admin:{snacks:String(a.snacks??""),drinks:String(a.drinks??""),beer:String(a.beer??""),bar:String(a.bar??"")},km:{tobacco:String(k.tobacco??"")}};
  };
  const pickPersonField=(src,name)=>{
    if(src[name]!=null) return String(src[name]);
    const legacy=Object.keys(LEGACY_NAME_MAP).find(k=>LEGACY_NAME_MAP[k]===name && src[k]!=null);
    return legacy?String(src[legacy]):"";
  };
  const normalizeAdv=adv=>{
    const base={}; [...ADMINS,...KMS].forEach(n=>base[n]="");
    const src=adv&&typeof adv==="object"?adv:{};
    Object.keys(base).forEach(n=>base[n]=pickPersonField(src,n));
    return base;
  };
  const normalizeAdminSalary=sal=>{
    const base={}; ADMINS.forEach(n=>base[n]="");
    const src=sal&&typeof sal==="object"?sal:{};
    ADMINS.forEach(n=>base[n]=pickPersonField(src,n));
    return base;
  };
  const normalizeBonus=bn=>{
    const base={}; [...ADMINS,...KMS].forEach(n=>base[n]="");
    const src=bn&&typeof bn==="object"?bn:{};
    Object.keys(base).forEach(n=>base[n]=pickPersonField(src,n));
    return base;
  };
  const normalizeDayTextMap=x=>{
    const src=x&&typeof x==="object"?x:{};
    const out={};
    Object.keys(src).forEach(k=>out[k]=String(src[k]??""));
    return out;
  };
  const cap=s=>{const t=String(s||"").trim(); return t? t.charAt(0).toUpperCase()+t.slice(1).toLowerCase() : "";};
  const formatStaffName=raw=>{
    const txt=String(raw||"").trim().replace(/\s+/g," ");
    if(!txt) return{display:"",full:""};
    const parts=txt.split(" ");
    if(parts.length>=2){
      const sur=cap(parts[0]);
      const nm=cap(parts[1]);
      return{display:`${sur} ${nm.charAt(0)}.`,full:`${sur} ${nm}`};
    }
    return{display:cap(parts[0]),full:cap(parts[0])};
  };
  const normalizeStaff=arr=>{
    const src=Array.isArray(arr)&&arr.length?arr:STAFF_DEFAULT;
    const out=src.map((s,idx)=>{
      const f=formatStaffName((s&&s.fullName)||s&&s.name||"");
      const roleRaw=String((s&&s.role)||"").trim();
      const role=(roleRaw==="admin"||roleRaw==="km"||roleRaw==="senior_admin"||roleRaw==="senior_km")?roleRaw:"km";
      return{
        id:String((s&&s.id)||`staff-${idx}-${Date.now()}`),
        name:(s&&s.name&&String(s.name).trim())||f.display||`Сотрудник ${idx+1}`,
        fullName:(s&&s.fullName&&String(s.fullName).trim())||f.full||((s&&s.name&&String(s.name).trim())||""),
        role,
        active:s&&s.active===false?false:true
      };
    });
    return out.filter(s=>s.active!==false && String(s.name||"").trim());
  };

  const defDay=dt=>({
    admin:[{name:ADMINS[0],hours:String(defHours("admin",dt)),breakage:""}],
    km_main:[{name:KMS[0],hours:String(defHours("km_main",dt)),breakage:""}],
    km_support:[{name:KMS[0],hours:String(defHours("km_support",dt)),breakage:""}],
    km_support2:isFriSat(dt)?[{name:KMS[0],hours:String(defHours("km_support2",dt)),breakage:""}]:[],
  });

  const alloc=(total,rows)=>{
    const hs=(rows||[]).map(r=>h0(r&&r.hours));
    const s=hs.reduce((a,b)=>a+b,0);
    if(s<=0) return (rows||[]).map(()=>0);
    return hs.map(h=>total*h/s);
  };
  const fmtHours=v=>{
    if(!Number.isFinite(v)) return "0";
    const n=Math.round(v*100)/100;
    return String(n).replace(/\.00$/,"").replace(/(\.\d)0$/,"$1");
  };

  const sumHours=(rows)=> (Array.isArray(rows)?rows:[]).reduce((a,r)=>a + h0(r && r.hours), 0);

  const safeGet=()=>{try{const raw=localStorage.getItem(STORAGE_KEY);const p=raw?JSON.parse(raw):null;return p&&typeof p==="object"?p:{months:{}};}catch(e){return{months:{}};}};
  const safeSet=obj=>{try{localStorage.setItem(STORAGE_KEY,JSON.stringify(obj));}catch(e){}};
  const safeGetTheme=()=>{try{const t=localStorage.getItem(THEME_KEY);return t==="light"?"light":"dark";}catch(e){return"dark";}};
  const safeSetTheme=t=>{try{localStorage.setItem(THEME_KEY,t);}catch(e){}};
  const getCfg=()=>window.__FOT_CFG__&&typeof window.__FOT_CFG__==="object"?window.__FOT_CFG__:{};

  const cloud={
    started:false,
    enabled:false,
    authReady:false,
    viewOnlyForced:false,
    role:"viewer",
    workspaceId:"default",
    supabase:null,
    session:null,
    saveSeq:0,
    ignoreNextRealtime:0,
    channel:null,
    store:{months:{},staff:STAFF_DEFAULT},
  };

  const state={
    view:"dashboard",
    year:(new Date()).getFullYear(),
    month:(new Date()).getMonth(),
    rev:{},
    unpaid:{},
    asgn:{},
    adv:normalizeAdv(null),
    bonus:normalizeBonus(null),
    inv:normalizeInv(null),
    rates:normalizeRates(null),
    manager:{percent:"",seniorBonus:""},
    adminSalary:normalizeAdminSalary(null),
    seniorKm:"",
    dayComment:{},
    activeDay:null,
    loadedKey:null,
    hydrating:false,
    saveTimer:null,
    theme:safeGetTheme(),
    authLoading:true,
    authBusy:false,
    authError:"",
    email:"",
    password:"",
    readOnly:false,
    confirmClear:false,
    scheduleText:"",
    scheduleStatus:"",
    scheduleError:"",
    staff:normalizeStaff(STAFF_DEFAULT),
  };
  const canEdit=()=>!state.readOnly;
  const syncRoleLists=()=>{
    const active=normalizeStaff(state.staff);
    state.staff=active;
    ADMINS=active.filter(s=>s.role==="admin"||s.role==="senior_admin").map(s=>s.name);
    KMS=active.filter(s=>s.role==="km"||s.role==="senior_km").map(s=>s.name);
    MANAGER_NAME=(active.find(s=>s.role==="senior_admin")||active.find(s=>s.role==="admin")||{name:"—"}).name;
    SENIOR_KM_NAME=(active.find(s=>s.role==="senior_km")||active.find(s=>s.role==="km")||{name:"—"}).name;
    if(ADMINS.length===0) ADMINS=["Слесарева К."];
    if(KMS.length===0) KMS=["Линиченко Ю."];
  };
  syncRoleLists();
  const NAME_ALIASES={
    "леня":"Родин Л.",
    "лёня":"Родин Л.",
    "леонид":"Родин Л.",
    "родинл":"Родин Л.",
    "рудик":"Луя Р.",
    "рудольф":"Луя Р.",
    "луяр":"Луя Р.",
    "юра":"Линиченко Ю.",
    "линиченкою":"Линиченко Ю.",
    "женя":"Золотарев Е.",
    "золотареве":"Золотарев Е.",
    "крис":"Слесарева К.",
    "кристина":"Слесарева К.",
    "слесаревак":"Слесарева К.",
    "миша":"Григорьев М.",
    "михаил":"Григорьев М.",
    "григорьевм":"Григорьев М.",
    "дарья":"Павлова Д.",
    "даша":"Павлова Д.",
    "павловад":"Павлова Д.",
  };

  const cleanName=s=>String(s||"").trim().toLowerCase().replace(/\./g,"").replace(/\s+/g,"").replace(/ё/g,"е");
  const normalizePerson=(raw, list)=>{
    const k=cleanName(raw);
    const ali=NAME_ALIASES[k];
    if(ali && list.includes(ali)) return ali;
    const fromStaff=(state.staff||[]).find(s=>{
      if(!s || !list.includes(s.name)) return false;
      const dn=cleanName(s.name);
      if(dn===k) return true;
      const full=cleanName(s.fullName||"");
      if(full===k) return true;
      const parts=String(s.fullName||"").trim().split(/\s+/).filter(Boolean);
      const first=parts[1]?cleanName(parts[1]):"";
      if(first && first.startsWith(k)) return true;
      const sur=parts[0]?cleanName(parts[0]):"";
      if(sur && sur.startsWith(k)) return true;
      return false;
    });
    if(fromStaff) return fromStaff.name;
    const hit=list.find(x=>cleanName(x)===k);
    return hit||null;
  };

  const normalizeMonthData=d=>({
    rev:(d&&d.rev)||{},
    unpaid:(d&&d.unpaid)||{},
    asgn:(d&&d.asgn)||{},
    adv:normalizeAdv(d&&d.adv),
    bonus:normalizeBonus(d&&d.bonus),
    inv:normalizeInv(d&&d.inv),
    rates:normalizeRates(d&&d.rates),
    manager:{percent:String(((d&&d.manager)||{}).percent??""),seniorBonus:String(((d&&d.manager)||{}).seniorBonus??"")},
    adminSalary:normalizeAdminSalary(d&&d.adminSalary),
    seniorKm:String((d&&d.seniorKm)??""),
    dayComment:normalizeDayTextMap(d&&d.dayComment),
  });

  const tierFrom=r=>r>=70000?{id:"tier3",name:"≥ 70 000"}:r>=50000?{id:"tier2",name:"50 000–69 999"}:{id:"tier1",name:"< 50 000"};

  const computeForDay=(revenue, assigns)=>{
    const tier=tierFrom(revenue);
    const rr=normalizeRates(state.rates)[tier.id];

    const a=n0(rr.admin)/100;
    const km=n0(rr.km_main)/100;
    const ks=n0(rr.km_support)/100;

    const adminTotal=revenue*a;
    const kmMainTotal=revenue*km;

    const supportPool=revenue*ks;

    const supHours=sumHours(assigns && assigns.km_support);
    const sup2Hours=sumHours(assigns && assigns.km_support2);

    let sup2Total=0;
    if(supHours>0 && sup2Hours>0){
      sup2Total=(supportPool/supHours)*sup2Hours;
      if(sup2Total>supportPool) sup2Total=supportPool;
    }

    return{tier,totals:{admin:adminTotal,km_main:kmMainTotal,km_support:supportPool,km_support2:sup2Total}};
  };

  const dim=()=>new Date(state.year,state.month+1,0).getDate();
  const key=()=>monthKey(state.year,state.month);
  const dayRevenueTotal=d=>n0(state.rev[d])+n0(state.unpaid[d]);
  const emptyStore=()=>({months:{},staff:normalizeStaff(STAFF_DEFAULT)});

  const toStoreSnapshot=()=>{
    const k=key();
    const next={...cloud.store,months:{...(cloud.store.months||{})}};
    next.staff=normalizeStaff(state.staff);
    next.months[k]={
      rev:state.rev,
      unpaid:state.unpaid,
      asgn:state.asgn,
      adv:state.adv,
      bonus:state.bonus,
      inv:normalizeInv(state.inv),
      rates:normalizeRates(state.rates),
      manager:state.manager,
      adminSalary:state.adminSalary,
      seniorKm:state.seniorKm,
      dayComment:normalizeDayTextMap(state.dayComment)
    };
    return next;
  };

  const cloudSave=async(nextStore)=>{
    if(!cloud.enabled || !cloud.supabase || !cloud.session || !canEdit()) return;
    cloud.saveSeq+=1;
    const seq=cloud.saveSeq;
    cloud.ignoreNextRealtime+=1;
    const {error}=await cloud.supabase.from("workspace_states").upsert({
      workspace_id:cloud.workspaceId,
      data:nextStore,
      updated_at:new Date().toISOString()
    },{onConflict:"workspace_id"});
    if(error){
      if(seq===cloud.saveSeq){
        state.authError=`Ошибка сохранения: ${error.message}`;
        render();
      }
      cloud.ignoreNextRealtime=Math.max(0,cloud.ignoreNextRealtime-1);
    }
  };

  const subscribeRealtime=()=>{
    if(!cloud.enabled || !cloud.supabase) return;
    if(cloud.channel) cloud.supabase.removeChannel(cloud.channel);
    cloud.channel=cloud.supabase.channel(`workspace:${cloud.workspaceId}`);
    cloud.channel.on("postgres_changes",{
      event:"UPDATE",
      schema:"public",
      table:"workspace_states",
      filter:`workspace_id=eq.${cloud.workspaceId}`
    },payload=>{
      if(cloud.ignoreNextRealtime>0){
        cloud.ignoreNextRealtime-=1;
        return;
      }
      const incoming=payload&&payload.new&&payload.new.data;
      cloud.store=(incoming&&typeof incoming==="object")?incoming:emptyStore();
      if(state.loadedKey){
        loadMonth(key());
      }
    }).subscribe();
  };

  const fetchRole=async(userId)=>{
    const {data,error}=await cloud.supabase.from("workspace_members")
      .select("role")
      .eq("workspace_id",cloud.workspaceId)
      .eq("user_id",userId)
      .maybeSingle();
    if(error) throw error;
    return data&&data.role==="editor"?"editor":"viewer";
  };

  const fetchStore=async()=>{
    const {data,error}=await cloud.supabase.from("workspace_states")
      .select("data")
      .eq("workspace_id",cloud.workspaceId)
      .maybeSingle();
    if(error) throw error;
    if(!data){
      if(canEdit()){
        const init=emptyStore();
        const {error:insErr}=await cloud.supabase.from("workspace_states").insert({workspace_id:cloud.workspaceId,data:init});
        if(insErr) throw insErr;
        return init;
      }
      return emptyStore();
    }
    return (data.data&&typeof data.data==="object")?data.data:emptyStore();
  };

  const hydrateBySession=async(session)=>{
    cloud.session=session;
    state.authError="";
    state.authLoading=true;
    render();
    const user=session&&session.user;
    if(!user){
      state.authLoading=false;
      render();
      return;
    }
    try{
      cloud.role=await fetchRole(user.id);
      state.readOnly=cloud.viewOnlyForced || cloud.role!=="editor";
      cloud.store=await fetchStore();
      state.authLoading=false;
      loadMonth(key());
      if(cloud.enabled) subscribeRealtime();
    }catch(err){
      state.authLoading=false;
      state.authError=err&&err.message?err.message:"Не удалось загрузить рабочее пространство";
      render();
    }
  };

  const initCloud=async()=>{
    if(cloud.started) return;
    cloud.started=true;
    const cfg=getCfg();
    cloud.workspaceId=String(cfg.workspaceId||"default");
    cloud.viewOnlyForced=!!cfg.viewOnly;
    const supabaseUrl=String(cfg.supabaseUrl||"");
    const supabaseAnonKey=String(cfg.supabaseAnonKey||"");
    if(!supabaseUrl || !supabaseAnonKey || !window.supabase || !window.supabase.createClient){
      cloud.enabled=false;
      cloud.store=safeGet();
      state.readOnly=cloud.viewOnlyForced;
      state.authLoading=false;
      loadMonth(key());
      return;
    }
    cloud.enabled=true;
    cloud.supabase=window.supabase.createClient(supabaseUrl,supabaseAnonKey);
    const {data:{session},error}=await cloud.supabase.auth.getSession();
    if(error){
      state.authError=error.message;
      state.authLoading=false;
      render();
      return;
    }
    if(!session){
      state.authLoading=false;
      render();
      return;
    }
    await hydrateBySession(session);
  };

  const getDay=(d,dt)=>state.asgn[d]||defDay(dt);

  const scheduleSave=()=>{
    if(state.hydrating) return;
    if(state.saveTimer) clearTimeout(state.saveTimer);
    state.saveTimer=setTimeout(saveNow,200);
  };
  const saveNow=()=>{
    if(state.hydrating) return;
    const k=key();
    if(state.loadedKey!==k) return;
    const next=toStoreSnapshot();
    cloud.store=next;
    if(cloud.enabled){
      cloudSave(next);
    }else{
      safeSet(next);
    }
  };

  const loadMonth=(k)=>{
    state.hydrating=true;
    const store=cloud.store&&typeof cloud.store==="object"?cloud.store:emptyStore();
    state.staff=normalizeStaff(store.staff);
    syncRoleLists();
    state.adv=normalizeAdv(state.adv);
    state.bonus=normalizeBonus(state.bonus);
    state.adminSalary=normalizeAdminSalary(state.adminSalary);
    const d=store.months&&store.months[k];
    if(!d){
      state.rev={};
      state.unpaid={};
      state.asgn={};
      state.adv=normalizeAdv(null);
      state.bonus=normalizeBonus(null);
      state.inv=normalizeInv(null);
      state.rates=normalizeRates(null);
      state.manager={percent:"",seniorBonus:""};
      state.adminSalary=normalizeAdminSalary(null);
      state.seniorKm="";
      state.dayComment={};
      state.activeDay=null;
      state.loadedKey=k;
      state.hydrating=false;
      render();
      return;
    }
    state.rev=d.rev||{};
    state.unpaid=d.unpaid||{};
    state.asgn=d.asgn||{};
    state.adv=normalizeAdv(d.adv);
    state.bonus=normalizeBonus(d.bonus);
    state.inv=normalizeInv(d.inv);
    state.rates=normalizeRates(d.rates);
    state.manager={percent:String((d.manager||{}).percent??""),seniorBonus:String((d.manager||{}).seniorBonus??"")};
    state.adminSalary=normalizeAdminSalary(d.adminSalary);
    state.seniorKm=String(d.seniorKm??"");
    state.dayComment=normalizeDayTextMap(d.dayComment);
    state.activeDay=null;
    state.loadedKey=k;
    state.hydrating=false;
    render();
  };

  const shiftMonth=delta=>{
    const d=new Date(state.year,state.month+delta,1);
    state.year=d.getFullYear();
    state.month=d.getMonth();
    loadMonth(key());
  };

  const tierClass=rev=>rev>0?(rev>=70000?"grn":rev>=50000?"yel":"red"):"";

  const uniqNames=rows=>{
    const out=[]; const s=new Set();
    (rows||[]).forEach(r=>{
      const n=String((r&&r.name)||"").trim();
      if(!n||s.has(n)) return;
      s.add(n); out.push(n);
    });
    return out;
  };

  const calcMonthTotals=()=>{
    let rawRevenue=0, unpaidRevenue=0, fotNet=0;
    const sumField=(arr,field)=>(arr||[]).reduce((a,r)=>a+Math.max(0,m0(r&&r[field])),0);
    const days=dim();
    for(let d=1; d<=days; d++){
      const dt=new Date(state.year,state.month,d);
      const raw=n0(state.rev[d]);
      const bo=n0(state.unpaid[d]);
      const r=raw+bo;
      rawRevenue+=raw;
      unpaidRevenue+=bo;
      const a=getDay(d,dt);
      const {totals}=computeForDay(r,a);
      const br=sumField(a.admin,"breakage")+sumField(a.km_main,"breakage")+sumField(a.km_support,"breakage")+sumField(a.km_support2,"breakage");
      const gross=totals.admin+totals.km_main+totals.km_support+totals.km_support2;
      fotNet+=gross-br;
    }
    const revenue=rawRevenue+unpaidRevenue;
    const bonusSum=[...new Set([...ADMINS,...KMS])].reduce((a,name)=>a+Math.max(0,m0(state.bonus[name])),0);
    const managerPay=(revenue*n0(state.manager.percent)/100)+Math.max(0,m0(state.manager.seniorBonus));
    fotNet+=bonusSum+managerPay;
    return{rawRevenue,unpaidRevenue,revenue,fotNet};
  };

  const calcPeopleTotals=()=>{
    const adminTotals={}; const kmTotals={};
    ADMINS.forEach(n=>adminTotals[n]={gross:0,breakage:0});
    KMS.forEach(n=>kmTotals[n]={gross:0,breakage:0});

    const add=(roleTotal,roleRows,target)=>{
      const rr=Array.isArray(roleRows)?roleRows:[];
      const payouts=alloc(roleTotal,rr);
      for(let i=0;i<rr.length;i++){
        const name=String((rr[i]&&rr[i].name)||"").trim();
        if(!name) continue;
        if(!target[name]) target[name]={gross:0,breakage:0};
        target[name].gross+=(payouts[i]||0);
        target[name].breakage+=Math.max(0,m0(rr[i]&&rr[i].breakage));
      }
    };

    const days=dim();
    for(let d=1; d<=days; d++){
      const dt=new Date(state.year,state.month,d);
      const r=dayRevenueTotal(d);
      const a=state.asgn[d]||defDay(dt);
      const {totals}=computeForDay(r,a);
      add(totals.admin,a.admin,adminTotals);
      add(totals.km_main,a.km_main,kmTotals);
      add(totals.km_support,a.km_support,kmTotals);
      add(totals.km_support2,a.km_support2,kmTotals);
    }
    return{adminTotals,kmTotals};
  };

  const calcShiftCounts=()=>{
    const adminCounts={}; const kmCounts={};
    ADMINS.forEach(n=>adminCounts[n]=0);
    KMS.forEach(n=>kmCounts[n]={km_main:0,km_support:0,km_support2:0});

    const add=(rows,target,list)=>{
      (rows||[]).forEach(r=>{
        const raw=String((r&&r.name)||"").trim();
        if(!raw) return;
        const name=normalizePerson(raw,list) || LEGACY_NAME_MAP[raw] || raw;
        if(target[name]==null) return;
        target[name]+=1;
      });
    };
    const addKm=(rows,key)=>{
      (rows||[]).forEach(r=>{
        const raw=String((r&&r.name)||"").trim();
        if(!raw) return;
        const name=normalizePerson(raw,KMS) || LEGACY_NAME_MAP[raw] || raw;
        if(!kmCounts[name]) return;
        kmCounts[name][key]+=1;
      });
    };

    const days=dim();
    for(let d=1; d<=days; d++){
      if(dayRevenueTotal(d)<=0) continue;
      const dt=new Date(state.year,state.month,d);
      const a=getDay(d,dt);
      add(a.admin,adminCounts,ADMINS);
      addKm(a.km_main,"km_main");
      addKm(a.km_support,"km_support");
      addKm(a.km_support2,"km_support2");
    }
    return{adminCounts,kmCounts};
  };

  const html=(s)=>String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));

  function render(){
    const pageBg=state.theme==="light"?"#f5f7fb":"#09090b";
    document.body.style.background=pageBg;
    document.documentElement.style.background=pageBg;

    if(state.authLoading){
      el.innerHTML=`<div class="bg theme-${state.theme}"><div class="wrap"><div class="card"><div class="card-h"><div><div class="t">FOT</div><div class="st">Загрузка данных...</div></div></div></div></div></div>`;
      return;
    }

    if(cloud.enabled && !cloud.session){
      const err=state.authError?`<div class="hint" style="color:#ef4444;margin-top:8px">${html(state.authError)}</div>`:"";
      const busy=state.authBusy?"disabled":"";
      el.innerHTML=`<div class="bg theme-${state.theme}"><div class="wrap"><div class="card" style="width:min(25vw,420px);min-width:min(92vw,320px);margin:10vh auto 0"><div class="card-h"><div><div class="t">Вход</div><div class="st">Авторизуйся, чтобы открыть рабочее пространство</div></div></div><div class="card-b"><div class="row"><input class="inp" placeholder="Email" data-act="authEmail" value="${html(state.email)}"><input class="inp" placeholder="Пароль" type="password" data-act="authPassword" value="${html(state.password)}"><button class="btn primary" data-act="signIn" ${busy}>Войти</button>${err}</div></div></div></div></div>`;
      return;
    }

    const days=dim();
    const mk=key();
    const mt=calcMonthTotals();
    const pt=calcPeopleTotals();
    const sc=calcShiftCounts();

    const cal=(()=>{
      const fd=new Date(state.year,state.month,1);
      const start=monIdx(fd.getDay());
      const total=Math.ceil((start+days)/7)*7;
      let h=`<div class="card"><div class="card-h"><div><div class="t">Календарь</div><div class="st">Клик по дню — открыть редактор</div></div><button class="btn ghost" data-act="clearMonth" ${state.readOnly?"disabled":""}>Очистить месяц</button></div><div class="card-b">`;
      h+=`<div class="cal-head">${WEEKDAYS.map(w=>`<div>${w}</div>`).join("")}</div>`;
      h+=`<div class="cal-grid">`;
      for(let i=0;i<total;i++){
        const d=i-start+1;
        if(d<1||d>days){ h+=`<div class="cell"></div>`; continue; }
        const dt=new Date(state.year,state.month,d);
        const rev=dayRevenueTotal(d);
        const a=getDay(d,dt);
        const admins=uniqNames(a.admin).join(", ")||"—";
        const kms=uniqNames([...(a.km_main||[]),...(a.km_support||[]),...(a.km_support2||[])]).join(", ")||"—";
        const cls=tierClass(rev);
        h+=`<div class="cell ${cls}"><div class="day" data-act="openDay" data-day="${d}">`;
        h+=`<div class="daytop"><div class="dnum">${d}</div><div class="drev">${rev?html(money(rev)):""}</div></div>`;
        h+=`<div class="small"><div>А: ${html(admins)}</div><div>КМ: ${html(kms)}</div></div>`;
        h+=`</div></div>`;
      }
      h+=`</div>`;
      h+=`<div class="cal-nav"><button class="btn ghost" data-act="prevMonth">← Пред.</button><div class="mid">${MONTHS[state.month]} ${state.year}</div><button class="btn ghost" data-act="nextMonth">След. →</button></div>`;
      h+=`</div></div>`;
      return h;
    })();

    const legend=(()=>{
      let h=`<div class="legend"><div class="t">Легенда тарифов</div>`;
      h+=`<div style="margin-top:12px" class="row">`;
      h+=`<div class="lg"><div><span class="dot" style="background:rgba(244,63,94,.65)"></span>&lt; 50 000</div><div class="muted">красный</div></div>`;
      h+=`<div class="lg"><div><span class="dot" style="background:rgba(245,158,11,.65)"></span>50 000–69 999</div><div class="muted">жёлтый</div></div>`;
      h+=`<div class="lg"><div><span class="dot" style="background:rgba(16,185,129,.65)"></span>≥ 70 000</div><div class="muted">зелёный</div></div>`;
      h+=`</div></div>`;
      return h;
    })();

    const settings=(()=>{
      const r=normalizeRates(state.rates);
      const tiers=[{id:"tier1",t:"< 50 000"},{id:"tier2",t:"50 000–69 999"},{id:"tier3",t:"≥ 70 000"}];
      let h=`<div class="card"><div class="card-h"><div><div class="t">Настройки</div><div class="st">Процентные ставки по тарифам</div></div></div><div class="card-b"><div class="row">`;
      tiers.forEach(x=>{
        h+=`<div class="section"><div class="secT">${x.t}</div><div class="row2" style="margin-top:12px">`;
        h+=`<div><div class="muted" style="margin-bottom:6px">Админ %</div><input class="inp" data-act="setRate" data-tier="${x.id}" data-key="admin" value="${html(r[x.id].admin)}"></div>`;
        h+=`<div><div class="muted" style="margin-bottom:6px">КМ осн %</div><input class="inp" data-act="setRate" data-tier="${x.id}" data-key="km_main" value="${html(r[x.id].km_main)}"></div>`;
        h+=`<div><div class="muted" style="margin-bottom:6px">КМ сап %</div><input class="inp" data-act="setRate" data-tier="${x.id}" data-key="km_support" value="${html(r[x.id].km_support)}"></div>`;
        h+=`<div><div class="muted" style="margin-bottom:6px">КМ сап² %</div><input class="inp" data-act="setRate" data-tier="${x.id}" data-key="km_support2" value="${html(r[x.id].km_support2)}"></div>`;
        h+=`</div></div>`;
      });
      h+=`</div></div></div>`;
      h+=`<div class="card" style="margin-top:12px"><div class="card-h"><div><div class="t">Сотрудники</div><div class="st">Состав смен и должности</div></div></div><div class="card-b">`;
      h+=`<div class="tableWrap"><table><thead><tr><th style="width:48%">Фамилия и инициал</th><th style="width:38%">Должность</th><th class="r" style="width:14%"></th></tr></thead><tbody>`;
      state.staff.forEach((s,idx)=>{
        h+=`<tr>`;
        h+=`<td><input class="inp miniIn" style="text-align:left" data-act="setStaffName" data-idx="${idx}" value="${html(s.name||"")}"></td>`;
        h+=`<td><select class="sel miniIn" data-act="setStaffRole" data-idx="${idx}">`;
        h+=`<option value="admin" ${s.role==="admin"?"selected":""}>Администратор</option>`;
        h+=`<option value="senior_admin" ${s.role==="senior_admin"?"selected":""}>Старший Администратор</option>`;
        h+=`<option value="km" ${s.role==="km"?"selected":""}>Кальянный мастер</option>`;
        h+=`<option value="senior_km" ${s.role==="senior_km"?"selected":""}>Старший КМ</option>`;
        h+=`</select></td>`;
        h+=`<td class="r"><button class="del" data-act="removeStaff" data-idx="${idx}">×</button></td>`;
        h+=`</tr>`;
      });
      h+=`</tbody></table></div>`;
      h+=`<div style="margin-top:12px"><button class="btn primary" style="width:100%" data-act="addStaff">Добавить нового сотрудника</button></div>`;
      h+=`</div></div>`;
      return h;
    })();

    const people=(()=>{
      const inv=normalizeInv(state.inv);
      const adminInv=n0(inv.admin.snacks)+n0(inv.admin.drinks)+n0(inv.admin.beer)+n0(inv.admin.bar);
      const kmInv=n0(inv.km.tobacco);
      const adminShare=ADMINS.length?adminInv/ADMINS.length:0;
      const kmShare=KMS.length?kmInv/KMS.length:0;

      const adminRows=ADMINS.map(name=>{
        const gross=(pt.adminTotals[name]||{}).gross||0;
        const boj=(pt.adminTotals[name]||{}).breakage||0;
        const adv=Math.max(0,m0(state.adv[name]));
        const bonus=Math.max(0,m0(state.bonus[name]));
        const net=gross - boj - adv + bonus - adminShare;
        return{ name,gross,boj,adv,bonus,net };
      });

      const kmRows=KMS.map(name=>{
        const gross=(pt.kmTotals[name]||{}).gross||0;
        const boj=(pt.kmTotals[name]||{}).breakage||0;
        const adv=Math.max(0,m0(state.adv[name]));
        const bonus=Math.max(0,m0(state.bonus[name]));
        const net=gross - boj - adv + bonus - kmShare;
        return{ name,gross,boj,adv,bonus,net };
      });

      const sum=(arr,k)=>arr.reduce((a,r)=>a+(r[k]||0),0);

      let h=`<div class="card"><div class="card-h"><div><div class="t">Сводка сотрудников</div><div class="st">Авансы/премии/инвентаризация/доплаты</div></div></div><div class="card-b"><div class="row">`;

      h+=`<div class="section"><div class="secTop"><div><div class="secT">Администраторы</div><div class="secS">Инвентаризация: ${html(money(adminInv))} · по ${html(money(adminShare))}</div></div>`;
      h+=`<div style="width:min(280px,100%)"><div class="row2">`;
      h+=`<input class="inp miniIn" placeholder="Снэки" data-act="setInvA" data-key="snacks" value="${html(inv.admin.snacks)}">`;
      h+=`<input class="inp miniIn" placeholder="Напитки" data-act="setInvA" data-key="drinks" value="${html(inv.admin.drinks)}">`;
      h+=`<input class="inp miniIn" placeholder="Пиво" data-act="setInvA" data-key="beer" value="${html(inv.admin.beer)}">`;
      h+=`<input class="inp miniIn" placeholder="Бар" data-act="setInvA" data-key="bar" value="${html(inv.admin.bar)}">`;
      h+=`</div></div></div>`;

      h+=`<div class="tableWrap"><table><thead><tr>`;
      h+=`<th style="width:28%">Сотр.</th><th class="r" style="width:14%">Нач.</th><th class="r" style="width:14%">Бой</th><th class="r" style="width:14%">Аванс</th><th class="r" style="width:14%">Премия</th><th class="r" style="width:16%">Итог</th>`;
      h+=`</tr></thead><tbody>`;
      adminRows.forEach(r=>{
        h+=`<tr><td class="tr">${html(r.name)}</td><td class="r">${html(money(r.gross))}</td>`;
        h+=`<td class="r">${html(money(r.boj))}</td>`;
        h+=`<td class="r"><input class="inp miniIn" data-act="setAdvance" data-name="${html(r.name)}" value="${html(state.adv[r.name]||"")}"></td>`;
        h+=`<td class="r"><input class="inp miniIn" data-act="setBonus" data-name="${html(r.name)}" value="${html(state.bonus[r.name]||"")}"></td>`;
        h+=`<td class="r" style="font-weight:800">${html(money(r.net))}</td></tr>`;
      });
      h+=`</tbody><tfoot><tr><td>Итого</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"gross")))}</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"boj")))}</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"adv")))}</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"bonus")))}</td>`;
      h+=`<td class="r">${html(money(sum(adminRows,"net")))}</td></tr></tfoot></table></div></div>`;

      h+=`<div class="section"><div class="secTop"><div><div class="secT">Кальянные мастера</div><div class="secS">Инвентаризация: ${html(money(kmInv))} · по ${html(money(kmShare))}</div></div>`;
      h+=`<div style="width:min(280px,100%)">`;
      h+=`<div class="muted" style="margin-bottom:6px">Доплата старшему (${html(SENIOR_KM_NAME)})</div>`;
      h+=`<input class="inp miniIn" data-act="setSeniorKm" value="${html(state.seniorKm||"")}">`;
      h+=`<div style="margin-top:10px"><input class="inp miniIn" placeholder="Табак" data-act="setInvK" value="${html(inv.km.tobacco)}"></div>`;
      h+=`</div></div>`;

      h+=`<div class="tableWrap"><table><thead><tr>`;
      h+=`<th style="width:28%">Сотр.</th><th class="r" style="width:16%">Нач.</th><th class="r" style="width:14%">Бой</th><th class="r" style="width:14%">Аванс</th><th class="r" style="width:14%">Премия</th><th class="r" style="width:14%">Итог</th>`;
      h+=`</tr></thead><tbody>`;
      kmRows.forEach(r=>{
        h+=`<tr><td class="tr">${html(r.name)}</td><td class="r">${html(money(r.gross))}</td>`;
        h+=`<td class="r">${html(money(r.boj))}</td>`;
        h+=`<td class="r"><input class="inp miniIn" data-act="setAdvance" data-name="${html(r.name)}" value="${html(state.adv[r.name]||"")}"></td>`;
        h+=`<td class="r"><input class="inp miniIn" data-act="setBonus" data-name="${html(r.name)}" value="${html(state.bonus[r.name]||"")}"></td>`;
        h+=`<td class="r" style="font-weight:800">${html(money(r.net))}</td></tr>`;
      });
      h+=`</tbody><tfoot><tr><td>Итого</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"gross")))}</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"boj")))}</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"adv")))}</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"bonus")))}</td>`;
      h+=`<td class="r">${html(money(sum(kmRows,"net")))}</td></tr></tfoot></table></div></div>`;

      h+=`</div></div></div>`;
      return h;
    })();

    const manager=(()=>{
      const pct=n0(state.manager.percent);
      const pay=mt.revenue*pct/100;
      const senior=Math.max(0,m0(state.manager.seniorBonus));
      let h=`<div class="card"><div class="card-h"><div><div class="t">Управляющая</div><div class="st">${MANAGER_NAME} · Итог: ${html(money(pay+senior))}</div></div></div><div class="card-b">`;
      h+=`<div class="row2">`;
      h+=`<div><div class="muted" style="margin-bottom:6px">Процент от выручки месяца (%)</div><input class="inp" data-act="setManager" data-key="percent" value="${html(state.manager.percent||"")}"></div>`;
      h+=`<div><div class="muted" style="margin-bottom:6px">Доплата старшего администратора</div><input class="inp" data-act="setManager" data-key="seniorBonus" value="${html(state.manager.seniorBonus||"")}"></div>`;
      h+=`</div>`;
      h+=`<div class="section" style="margin-top:12px"><div class="muted">Расчёт</div><div style="margin-top:6px;font-size:18px;font-weight:900">${html(money(pay+senior))}</div><div class="muted" style="margin-top:6px">${html(money(pay))} + ${html(money(senior))}</div></div>`;
      h+=`</div></div>`;
      return h;
    })();

    const totals=(()=>{
      let h=`<div class="card"><div class="card-h"><div><div class="t">Итого</div><div class="st">Сводка месяца</div></div></div><div class="card-b"><div class="row">`;
      h+=`<div class="section"><div class="muted">Голая выручка</div><div style="margin-top:6px;font-size:22px;font-weight:900">${html(money(mt.rawRevenue))}</div></div>`;
      h+=`<div class="section"><div class="muted">БО</div><div style="margin-top:6px;font-size:22px;font-weight:900">${html(money(mt.unpaidRevenue))}</div></div>`;
      h+=`<div class="section"><div class="muted">Общая выручка</div><div style="margin-top:6px;font-size:22px;font-weight:900">${html(money(mt.revenue))}</div></div>`;
      h+=`<div class="section"><div class="muted">ФОТ (нетто)</div><div style="margin-top:6px;font-size:22px;font-weight:900">${html(money(mt.fotNet))}</div></div>`;
      h+=`</div></div></div>`;
      return h;
    })();

    const sidebar=(()=>{
      const now=new Date();
      const yopts=Array.from({length:8}).map((_,i)=>now.getFullYear()-4+i);
      const modeTxt=state.readOnly?"Просмотр":"Редактор";
      let h=`<div class="card"><div class="card-h"><div><div class="t">ФОТ-калькулятор (Все Свои)</div><div class="st">Выручка: ${html(money(mt.revenue))} · ФОТ: ${html(money(mt.fotNet))}</div></div><div class="chip">${mk}</div></div><div class="card-b">`;
      h+=`<div class="row2" style="margin-bottom:10px">`;
      h+=`<div class="chip">Режим: ${modeTxt}</div>`;
      h+=cloud.enabled?`<button class="btn ghost" data-act="signOut">Выйти</button>`:`<div></div>`;
      h+=`</div>`;
      h+=`<div class="row2">`;
      h+=`<select class="sel" data-act="setYear">${yopts.map(y=>`<option value="${y}" ${y===state.year?"selected":""}>${y}</option>`).join("")}</select>`;
      h+=`<select class="sel" data-act="setMonth">${MONTHS.map((m,i)=>`<option value="${i}" ${i===state.month?"selected":""}>${html(m)}</option>`).join("")}</select>`;
      h+=`</div>`;
      h+=`<div class="tabs">`;
      h+=`<div class="pill ${state.view==="dashboard"?"on":"off"}" data-act="setView" data-view="dashboard">Дашборд</div>`;
      h+=`<div class="pill ${state.view==="settings"?"on":"off"}" data-act="setView" data-view="settings">Настройки</div>`;
      h+=`</div>`;
      h+=`<div class="muted" style="margin-top:12px">Тема</div>`;
      h+=`<div class="tabs">`;
      h+=`<div class="pill ${state.theme==="dark"?"on":"off"}" data-act="setTheme" data-theme="dark">Тёмная</div>`;
      h+=`<div class="pill ${state.theme==="light"?"on":"off"}" data-act="setTheme" data-theme="light">Светлая</div>`;
      h+=`</div>`;
      h+=`</div></div>`;

      h+=`<div class="card" style="margin-top:12px"><div class="card-h"><div><div class="t">Импорт графика</div><div class="st">Вставь недельный график и распредели смены автоматически</div></div></div><div class="card-b">`;
      h+=`<div class="row">`;
      h+=`<textarea class="ta" data-act="setScheduleText" placeholder="23.2.2026\nПн\nЛеня/Рудик/Крис">${html(state.scheduleText||"")}</textarea>`;
      h+=`<button class="btn primary" data-act="applySchedule" ${state.readOnly?"disabled":""}>Применить в календарь</button>`;
      if(state.scheduleStatus) h+=`<div class="hint" style="color:#16a34a">${html(state.scheduleStatus)}</div>`;
      if(state.scheduleError) h+=`<div class="hint" style="color:#ef4444">${html(state.scheduleError)}</div>`;
      h+=`</div></div></div>`;

      h+=`<div class="card" style="margin-top:12px"><div class="card-h"><div><div class="t">Количество смен</div><div class="st">Учитываются только дни с заполненной выручкой</div></div></div><div class="card-b">`;
      h+=`<div class="section"><div class="secT">Администраторы</div><div class="row" style="margin-top:10px">`;
      ADMINS.forEach(n=>{ h+=`<div class="lg"><div>${html(n)}</div><div class="chip">${sc.adminCounts[n]||0}</div></div>`; });
      h+=`</div></div>`;
      h+=`<div class="section" style="margin-top:10px"><div class="secT">Кальянные мастера</div>`;
      h+=`<div class="tableWrap" style="margin-top:10px"><table><thead><tr><th style="width:52%">Сотр.</th><th class="r" style="width:16%">КМ</th><th class="r" style="width:16%">КМс</th><th class="r" style="width:16%">КМс²</th></tr></thead><tbody>`;
      KMS.forEach(n=>{
        const c=sc.kmCounts[n]||{km_main:0,km_support:0,km_support2:0};
        h+=`<tr><td class="tr">${html(n)}</td><td class="r">${c.km_main||0}</td><td class="r">${c.km_support||0}</td><td class="r">${c.km_support2||0}</td></tr>`;
      });
      h+=`</tbody></table></div></div>`;
      h+=`</div></div>`;
      return h;
    })();

    const main=(()=>{
      if(state.view==="settings") return `<div class="split" style="grid-template-columns:2fr 1fr">${settings}<div>${legend}</div></div>`;
      return `<div class="row">${cal}${people}<div class="split">${manager}${totals}</div></div>`;
    })();

    const modal=(()=>{
      const open=state.activeDay!=null;
      const d=state.activeDay;
      const dt=open?new Date(state.year,state.month,d):null;
      const revBase=n0(open?state.rev[d]:0);
      const revUnpaid=n0(open?state.unpaid[d]:0);
      const rev=revBase+revUnpaid;
      const assigns=open?getDay(d,dt):null;
      const c=open?computeForDay(rev, assigns):{tier:{id:"tier1",name:"< 50 000"},totals:{admin:0,km_main:0,km_support:0,km_support2:0}};
      const tier=c.tier, totals=c.totals;

      const rolePanel=(title,roleKey,people,total,rows,allowEmpty)=>{
        const rr=Array.isArray(rows)?rows:[];
        const payouts=alloc(total,rr);
        const br=rr.map(r=>Math.max(0,m0(r&&r.breakage)));
        const net=payouts.map((p,i)=>p-(br[i]||0));

        let h=`<div class="role" data-role="${roleKey}"><div class="roleTop"><div><div class="roleT">${html(title)}</div><div class="roleS">Сумма роли: ${html(money(total))}</div></div>`;
        h+=`<button class="add" data-act="addRow" data-role="${roleKey}">+ Добавить</button></div>`;
        if(rr.length===0 && allowEmpty) h+=`<div class="hint">Нет записей. Добавь человека, если роль была в этот день.</div>`;
        if(rr.length>0){
          h+=`<div class="rgrid muted"><div class="col2"></div><div class="col4"></div><div class="col2">Кол-во часов</div><div class="col2">Бой</div><div class="col4"></div></div>`;
        }

        rr.forEach((r,idx)=>{
          h+=`<div class="rgrid">`;
          h+=`<div class="col2"><button class="del" data-act="delRow" data-role="${roleKey}" data-idx="${idx}">Удалить</button></div>`;
          h+=`<div class="col4"><select class="sel" data-act="setRow" data-role="${roleKey}" data-idx="${idx}" data-field="name">`+
            people.map(p=>`<option value="${html(p)}" ${p===(r.name||"")?"selected":""}>${html(p)}</option>`).join("")+
            `</select></div>`;
          h+=`<div class="col2"><input class="inp" data-act="setRow" data-role="${roleKey}" data-idx="${idx}" data-field="hours" value="${html(r.hours??"")}"></div>`;
          h+=`<div class="col2"><input class="inp" data-act="setRow" data-role="${roleKey}" data-idx="${idx}" data-field="breakage" value="${html(r.breakage??"")}" placeholder="Бой"></div>`;
          h+=`<div class="col4 payout"><div class="pTop">${html(money(net[idx]||0))}</div><div class="pSub">${html(money(payouts[idx]||0))} − ${html(money(br[idx]||0))}</div></div>`;
          h+=`</div>`;
        });

        h+=`</div>`;
        return h;
      };

      let h=`<div class="modal ${open?"on":""}" id="fot-modal"><div class="back" data-act="closeModal"></div><div class="sheet"><div class="dialog">`;
      h+=`<div class="dlgH"><div><div class="t">${open?`Редактор дня · ${pad2(d)}/${pad2(state.month+1)}/${state.year} (${wd(dt.getDay())})`:"Редактор дня"}</div>`;
      h+=`<div class="st">${open?`Тариф: ${tier.name} · Выручка: ${money(rev)} · Роли: ${money(totals.admin+totals.km_main+totals.km_support+totals.km_support2)}`:""}</div></div>`;
      h+=`<button class="btn ghost" data-act="closeModal">Закрыть</button></div>`;
      h+=`<div class="dlgB">`;

      if(open){
        h+=`<div class="section" style="margin-bottom:12px"><div class="row2" style="grid-template-columns:2fr 1fr">`;
        h+=`<div><div class="muted" style="margin-bottom:6px">Выручка дня</div><input class="inp" data-act="setDayRevenue" value="${html(state.rev[d]??"")}" placeholder="0"></div>`;
        h+=`<div><div class="muted" style="margin-bottom:6px">Без оплаты</div><input class="inp" data-act="setDayUnpaid" value="${html(state.unpaid[d]??"")}" placeholder="0"></div>`;
        h+=`</div>`;
        h+=`<div class="muted" style="margin-top:8px">Сейчас: ${html(money(rev))} = ${html(money(revBase))} + ${html(money(revUnpaid))} · Тариф: ${html(tier.name)}</div></div>`;

        h+=rolePanel("Администратор","admin",ADMINS,totals.admin,assigns.admin,false);
        h+=`<div style="height:10px"></div>`;
        h+=rolePanel("Кальянный мастер","km_main",KMS,totals.km_main,assigns.km_main,false);
        h+=`<div style="height:10px"></div>`;
        h+=rolePanel("КМ саппорт","km_support",KMS,totals.km_support,assigns.km_support,false);
        h+=`<div style="height:10px"></div>`;
        h+=rolePanel("КМ саппорт²","km_support2",KMS,totals.km_support2,assigns.km_support2,true);
        h+=`<div style="height:10px"></div>`;
        h+=`<div class="section"><div class="muted" style="margin-bottom:6px">Комментарий</div><textarea class="ta" data-act="setDayComment" placeholder="Комментарий">${html(state.dayComment[d]??"")}</textarea></div>`;
      }

      h+=`</div></div></div></div></div>`;
      return h;
    })();

    const clearModal=(()=>{
      if(!state.confirmClear) return "";
      let h=`<div class="modal on" id="fot-clear-modal"><div class="back" data-act="cancelClear"></div><div class="sheet"><div class="dialog" style="max-width:560px"><div class="dlgH"><div><div class="t">Подтверждение</div><div class="st">Вы уверены, что хотите удалить данные?</div></div></div><div class="dlgB"><div class="row2"><button class="btn contrast" data-act="cancelClear">Отмена</button><button class="btn primary" data-act="confirmClear">Подтвердить</button></div></div></div></div></div>`;
      return h;
    })();

    el.innerHTML=`<div class="bg theme-${state.theme}"><div class="wrap"><div class="grid"><div>${sidebar}</div><div class="min">${main}</div></div></div>${modal}${clearModal}</div>`;
    if(state.readOnly){
      const selectors=[
        "button[data-act='clearMonth']",
        "button[data-act='applySchedule']",
        "button[data-act='addStaff']",
        "button[data-act='removeStaff']",
        "button[data-act='addRow']",
        "button[data-act='delRow']",
        "input[data-act='setDayRevenue']",
        "input[data-act='setDayUnpaid']",
        "input[data-act='setRate']",
        "input[data-act='setInvA']",
        "input[data-act='setInvK']",
        "input[data-act='setAdvance']",
        "input[data-act='setBonus']",
        "input[data-act='setAdminSalary']",
        "input[data-act='setSeniorKm']",
        "input[data-act='setManager']",
        "input[data-act='setRow']",
        "input[data-act='setStaffName']",
        "select[data-act='setRow']",
        "select[data-act='setStaffRole']",
        "textarea[data-act='setDayComment']",
        "textarea[data-act='setScheduleText']"
      ];
      selectors.forEach(sel=>{
        el.querySelectorAll(sel).forEach(node=>{
          if("disabled" in node) node.disabled=true;
        });
      });
    }
  }

  function renderKeepFocus(){
    const root=el;
    const ae=document.activeElement;
    const inside=ae && root.contains(ae);
    const sx=window.scrollX;
    const sy=window.scrollY;

    let sel=null, ss=null, se=null;
    if(inside && ae.getAttribute){
      const act=ae.getAttribute("data-act");
      if(act){
        const parts=["[data-act='"+act+"']"];
        const attrs=["data-day","data-name","data-tier","data-key","data-role","data-idx","data-field","data-view"];
        attrs.forEach(a=>{
          const v=ae.getAttribute(a);
          if(v!=null) parts.push("["+a+"='"+CSS.escape(v)+"']");
        });
        sel=parts.join("");
      }
      if(typeof ae.selectionStart==="number"){
        ss=ae.selectionStart;
        se=ae.selectionEnd;
      }
    }

    render();

    if(sel){
      const el2=root.querySelector(sel);
      if(el2 && el2.focus){
        el2.focus({preventScroll:true});
        if(ss!=null && typeof el2.setSelectionRange==="function"){
          const len=(el2.value||"").length;
          const a=Math.min(ss,len);
          const b=Math.min(se==null?ss:se,len);
          try{ el2.setSelectionRange(a,b); }catch(e){}
        }
      }
    }
    window.scrollTo(sx,sy);
  }

  function setAssignDay(day,next){
    state.asgn={...state.asgn,[day]:next};
    scheduleSave();
  }

  function ensureDay(day){
    const dt=new Date(state.year,state.month,day);
    if(!state.asgn[day]) state.asgn={...state.asgn,[day]:defDay(dt)};
  }

  const submitSignIn=()=>{
    if(!cloud.enabled || !cloud.supabase || state.authBusy) return;
    state.authBusy=true;
    state.authError="";
    render();
    cloud.supabase.auth.signInWithPassword({
      email:String(state.email||"").trim(),
      password:String(state.password||"")
    }).then(async({data,error})=>{
      state.authBusy=false;
      if(error){
        state.authError=error.message;
        render();
        return;
      }
      state.password="";
      await hydrateBySession(data&&data.session?data.session:null);
    });
  };
  const applyStaffUpdate=nextStaff=>{
    state.staff=normalizeStaff(nextStaff);
    syncRoleLists();
    state.adv=normalizeAdv(state.adv);
    state.bonus=normalizeBonus(state.bonus);
    state.adminSalary=normalizeAdminSalary(state.adminSalary);
    scheduleSave();
    render();
  };

  const tryInitCloud=()=>{
    initCloud().catch(err=>{
      state.authLoading=false;
      state.authError=err&&err.message?err.message:"Ошибка инициализации";
      render();
    });
  };

  const parseScheduleText=text=>{
    const chunks=String(text||"").replace(/\r/g,"").split(/\n\s*\n+/).map(x=>x.trim()).filter(Boolean);
    const items=[];
    const errs=[];
    chunks.forEach((chunk,idx)=>{
      const lines=chunk.split("\n").map(x=>x.trim()).filter(Boolean);
      if(lines.length<3){
        errs.push(`Блок ${idx+1}: недостаточно строк`);
        return;
      }
      const m=lines[0].match(/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})$/);
      if(!m){
        errs.push(`Блок ${idx+1}: неверная дата "${lines[0]}"`);
        return;
      }
      const d=Number(m[1]), mo=Number(m[2]), yRaw=Number(m[3]);
      const y=yRaw<100?2000+yRaw:yRaw;
      const dt=new Date(y,mo-1,d);
      if(dt.getFullYear()!==y || dt.getMonth()!==mo-1 || dt.getDate()!==d){
        errs.push(`Блок ${idx+1}: несуществующая дата "${lines[0]}"`);
        return;
      }
      const names=(lines[2]||"").split("/").map(x=>x.trim()).filter(Boolean);
      const fs=isFriSat(dt);
      const need=fs?4:3;
      if(names.length<need){
        errs.push(`Блок ${idx+1}: нужно ${need} имени(имён), получено ${names.length}`);
        return;
      }
      const kmMain=normalizePerson(names[0],KMS);
      const kmSupport=normalizePerson(names[1],KMS);
      const admin=normalizePerson(names[fs?3:2],ADMINS);
      const kmSupport2=fs?normalizePerson(names[2],KMS):null;
      if(!kmMain || !kmSupport || !admin || (fs && !kmSupport2)){
        errs.push(`Блок ${idx+1}: не удалось распознать имена`);
        return;
      }
      items.push({
        date:dt,
        assign:{
          admin:[{name:admin,hours:String(defHours("admin",dt)),breakage:""}],
          km_main:[{name:kmMain,hours:String(defHours("km_main",dt)),breakage:""}],
          km_support:[{name:kmSupport,hours:String(defHours("km_support",dt)),breakage:""}],
          km_support2:fs?[{name:kmSupport2,hours:String(defHours("km_support2",dt)),breakage:""}]:[],
        }
      });
    });
    return{items,errs};
  };

  const applyScheduleImport=()=>{
    if(!canEdit()) return;
    const parsed=parseScheduleText(state.scheduleText);
    if(parsed.items.length===0){
      state.scheduleError=parsed.errs[0]||"Не удалось распознать график";
      state.scheduleStatus="";
      render();
      return;
    }
    const nextStore={...cloud.store,months:{...(cloud.store.months||{})}};
    parsed.items.forEach(item=>{
      const dt=item.date;
      const mk=monthKey(dt.getFullYear(),dt.getMonth());
      const md=normalizeMonthData(nextStore.months[mk]);
      md.asgn={...md.asgn,[dt.getDate()]:item.assign};
      nextStore.months[mk]=md;
    });
    cloud.store=nextStore;
    if(cloud.enabled) cloudSave(nextStore);
    else safeSet(nextStore);
    loadMonth(key());
    state.scheduleError=parsed.errs.length?`Импорт с предупреждениями: ${parsed.errs[0]}`:"";
    state.scheduleStatus=`Импортировано: ${parsed.items.length}`;
    render();
  };

  window.addEventListener("message",(ev)=>{
    if(ev.origin!==window.location.origin) return;
    const d=ev.data;
    if(!d || d.type!=="FOT_CONFIG") return;
    window.__FOT_CFG__={
      supabaseUrl:String(d.supabaseUrl||""),
      supabaseAnonKey:String(d.supabaseAnonKey||""),
      workspaceId:String(d.workspaceId||"default"),
      viewOnly:!!d.viewOnly
    };
    if(cloud.started && !cloud.enabled) cloud.started=false;
    tryInitCloud();
  });

  el.addEventListener("click",(e)=>{
    if(state.activeDay!=null){
      const trg=e.target;
      if(trg instanceof Element && trg.closest("#fot-modal") && !trg.closest(".dialog")){
        state.activeDay=null;
        render();
        return;
      }
    }

    const t=e.target.closest("[data-act]");
    if(!t) return;
    const act=t.getAttribute("data-act");

    if(act==="signIn"){
      submitSignIn();
      return;
    }
    if(act==="signOut"){
      if(!cloud.enabled || !cloud.supabase) return;
      cloud.supabase.auth.signOut().then(()=>{
        cloud.session=null;
        cloud.role="viewer";
        state.readOnly=true;
        state.activeDay=null;
        render();
      });
      return;
    }

    if(state.readOnly && ["clearMonth","addRow","delRow","confirmClear","applySchedule","addStaff","removeStaff"].includes(act)) return;

    if(act==="setView"){
      state.view=t.getAttribute("data-view");
      state.activeDay=null;
      render();
      return;
    }
    if(act==="setTheme"){
      state.theme=t.getAttribute("data-theme")==="light"?"light":"dark";
      safeSetTheme(state.theme);
      render();
      return;
    }
    if(act==="clearMonth"){
      state.confirmClear=true;
      render();
      return;
    }
    if(act==="cancelClear"){
      state.confirmClear=false;
      render();
      return;
    }
    if(act==="confirmClear"){
      state.rev={}; state.unpaid={}; state.asgn={}; state.dayComment={}; state.activeDay=null; state.confirmClear=false;
      scheduleSave();
      render();
      return;
    }
    if(act==="applySchedule"){
      applyScheduleImport();
      return;
    }
    if(act==="addStaff"){
      const next=[...state.staff,{id:`staff-${Date.now()}`,name:"Новый С.",fullName:"Новый Сотрудник",role:"km",active:true}];
      applyStaffUpdate(next);
      return;
    }
    if(act==="removeStaff"){
      const idx=Number(t.getAttribute("data-idx"));
      if(idx<0 || idx>=state.staff.length) return;
      const next=state.staff.slice();
      next.splice(idx,1);
      applyStaffUpdate(next);
      return;
    }
    if(act==="openDay"){
      const d=Number(t.getAttribute("data-day"));
      state.activeDay=d;
      ensureDay(d);
      render();
      return;
    }
    if(act==="closeModal"){
      state.activeDay=null;
      render();
      return;
    }
    if(act==="prevMonth"){ shiftMonth(-1); return; }
    if(act==="nextMonth"){ shiftMonth(1); return; }

    if(act==="addRow"){
      const role=t.getAttribute("data-role");
      const d=state.activeDay;
      if(!d) return;
      ensureDay(d);
      const day=state.asgn[d];
      const people=(role==="admin")?ADMINS:KMS;
      const dt=new Date(state.year,state.month,d);
      const prev=(day[role]||[]).slice();
      const totalHours=sumHours(prev)>0?sumHours(prev):defHours(role,dt);
      const nextRows=[...prev,{name:people[0],hours:"",breakage:""}];
      const share=nextRows.length>0?totalHours/nextRows.length:0;
      const balanced=nextRows.map(r=>({...r,hours:fmtHours(share)}));
      const next={...day,[role]:balanced};
      setAssignDay(d,next);
      render();
      return;
    }

    if(act==="delRow"){
      const role=t.getAttribute("data-role");
      const idx=Number(t.getAttribute("data-idx"));
      const d=state.activeDay;
      if(!d) return;
      ensureDay(d);
      const day=state.asgn[d];
      const arr=(day[role]||[]).slice();
      if(idx>=0 && idx<arr.length) arr.splice(idx,1);
      setAssignDay(d,{...day,[role]:arr});
      render();
      return;
    }
  });

  el.addEventListener("change",(e)=>{
    const t=e.target;
    if(!(t instanceof HTMLElement)) return;
    if(state.readOnly && (t.matches("select[data-act='setRow']") || t.matches("select[data-act='setStaffRole']"))) return;

    if(t.matches("select[data-act='setYear']")){
      state.year=Number(t.value);
      loadMonth(key());
      return;
    }
    if(t.matches("select[data-act='setMonth']")){
      state.month=Number(t.value);
      loadMonth(key());
      return;
    }
    if(t.matches("select[data-act='setRow']")){
      const role=t.getAttribute("data-role");
      const idx=Number(t.getAttribute("data-idx"));
      const field=t.getAttribute("data-field");
      const d=state.activeDay; if(!d) return;
      ensureDay(d);
      const day=state.asgn[d];
      const arr=(day[role]||[]).slice();
      const row={...arr[idx],[field]:t.value};
      arr[idx]=row;
      setAssignDay(d,{...day,[role]:arr});
      render();
      return;
    }
    if(t.matches("select[data-act='setStaffRole']")){
      const idx=Number(t.getAttribute("data-idx"));
      if(idx<0 || idx>=state.staff.length) return;
      const next=state.staff.slice();
      next[idx]={...next[idx],role:t.value};
      applyStaffUpdate(next);
      return;
    }
  });

  el.addEventListener("input",(e)=>{
    const t=e.target;
    if(!(t instanceof HTMLElement)) return;

    if(t.matches("input[data-act='authEmail']")){
      state.email=t.value;
      return;
    }
    if(t.matches("input[data-act='authPassword']")){
      state.password=t.value;
      return;
    }
    if(t.matches("textarea[data-act='setScheduleText']")){
      state.scheduleText=t.value;
      return;
    }
    if(t.matches("input[data-act='setStaffName']")){
      const idx=Number(t.getAttribute("data-idx"));
      if(idx<0 || idx>=state.staff.length) return;
      const raw=t.value;
      const f=formatStaffName(raw);
      const next=state.staff.slice();
      next[idx]={...next[idx],name:f.display||raw.trim(),fullName:f.full||raw.trim()};
      applyStaffUpdate(next);
      return;
    }

    if(state.readOnly && (
      t.matches("input[data-act='setDayRevenue']") ||
      t.matches("input[data-act='setDayUnpaid']") ||
      t.matches("input[data-act='setRate']") ||
      t.matches("input[data-act='setInvA']") ||
      t.matches("input[data-act='setInvK']") ||
      t.matches("input[data-act='setAdvance']") ||
      t.matches("input[data-act='setBonus']") ||
      t.matches("input[data-act='setAdminSalary']") ||
      t.matches("input[data-act='setSeniorKm']") ||
      t.matches("input[data-act='setManager']") ||
      t.matches("input[data-act='setRow']") ||
      t.matches("textarea[data-act='setDayComment']") ||
      t.matches("textarea[data-act='setScheduleText']") ||
      t.matches("input[data-act='setStaffName']")
    )) return;

    if(t.matches("input[data-act='setDayRevenue']")){
      const d=state.activeDay; if(!d) return;
      state.rev={...state.rev,[d]:t.value};
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setDayUnpaid']")){
      const d=state.activeDay; if(!d) return;
      state.unpaid={...state.unpaid,[d]:t.value};
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setRate']")){
      const tier=t.getAttribute("data-tier");
      const key2=t.getAttribute("data-key");
      const r=normalizeRates(state.rates);
      r[tier][key2]=t.value;
      state.rates=r;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setInvA']")){
      const k=t.getAttribute("data-key");
      const inv=normalizeInv(state.inv);
      inv.admin[k]=t.value;
      state.inv=inv;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setInvK']")){
      const inv=normalizeInv(state.inv);
      inv.km.tobacco=t.value;
      state.inv=inv;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setAdvance']")){
      const name=t.getAttribute("data-name");
      const adv=normalizeAdv(state.adv);
      adv[name]=t.value;
      state.adv=adv;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setBonus']")){
      const name=t.getAttribute("data-name");
      const bn=normalizeBonus(state.bonus);
      bn[name]=t.value;
      state.bonus=bn;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setAdminSalary']")){
      const name=t.getAttribute("data-name");
      const sal=normalizeAdminSalary(state.adminSalary);
      sal[name]=t.value;
      state.adminSalary=sal;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setSeniorKm']")){
      state.seniorKm=t.value;
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setManager']")){
      const k=t.getAttribute("data-key");
      state.manager={...state.manager,[k]:t.value};
      scheduleSave();
      renderKeepFocus();
      return;
    }
    if(t.matches("input[data-act='setRow']")){
      const role=t.getAttribute("data-role");
      const idx=Number(t.getAttribute("data-idx"));
      const field=t.getAttribute("data-field");
      const d=state.activeDay; if(!d) return;
      ensureDay(d);
      const day=state.asgn[d];
      const arr=(day[role]||[]).slice();
      const row={...arr[idx],[field]:t.value};
      arr[idx]=row;
      setAssignDay(d,{...day,[role]:arr});
      renderKeepFocus();
      return;
    }
    if(t.matches("textarea[data-act='setDayComment']")){
      const d=state.activeDay; if(!d) return;
      state.dayComment={...state.dayComment,[d]:t.value};
      scheduleSave();
      renderKeepFocus();
      return;
    }
  });

  window.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && cloud.enabled && !cloud.session){
      const ae=document.activeElement;
      if(ae && (ae.getAttribute("data-act")==="authEmail" || ae.getAttribute("data-act")==="authPassword")){
        e.preventDefault();
        submitSignIn();
        return;
      }
    }
    if(e.key==="Escape" && state.activeDay!=null){
      state.activeDay=null;
      render();
    }
  });

  setTimeout(tryInitCloud,CONFIG_WAIT_MS);
})();
</script>
</body>
</html>
